var E=(J,$)=>()=>($||J(($={exports:{}}).exports,$),$.exports);var g=E((E0,r)=>{E0.serialize=function(J){return J&&typeof J.toJSON==="function"?J.toJSON():J}});var $0=E((y0,J0)=>{var e=g().serialize;J0.exports=function J($,W){if(W=e(W),W===null||typeof W!=="object"||Array.isArray(W))return W;if($=e($),$===null||typeof $!=="object"||Array.isArray($))$={};var X=Object.keys(W);for(var Y=0;Y<X.length;Y++){var Z=X[Y];if(Z==="__proto__"||Z==="constructor"||Z==="prototype")return $;if(W[Z]===null){if($.hasOwnProperty(Z))delete $[Z]}else $[Z]=J($[Z],W[Z])}return $}});var X0=E((u0,W0)=>{W0.exports=function J($,W){if($===W)return!0;if($&&W&&typeof $=="object"&&typeof W=="object"){if($.constructor!==W.constructor)return!1;var X,Y,Z;if(Array.isArray($)){if(X=$.length,X!=W.length)return!1;for(Y=X;Y--!==0;)if(!J($[Y],W[Y]))return!1;return!0}if($.constructor===RegExp)return $.source===W.source&&$.flags===W.flags;if($.valueOf!==Object.prototype.valueOf)return $.valueOf()===W.valueOf();if($.toString!==Object.prototype.toString)return $.toString()===W.toString();if(Z=Object.keys($),X=Z.length,X!==Object.keys(W).length)return!1;for(Y=X;Y--!==0;)if(!Object.prototype.hasOwnProperty.call(W,Z[Y]))return!1;for(Y=X;Y--!==0;){var Q=Z[Y];if(!J($[Q],W[Q]))return!1}return!0}return $!==$&&W!==W}});var Z0=E((l0,Y0)=>{var G0=function(J,$){if(J.length!==$.length)return!1;for(var W=0;W<J.length;W++)if(!M0($[W],J[W]))return!1;return!0},M0=X0(),K=g().serialize;Y0.exports=function J($,W){if($=K($),W=K(W),$===null||W===null||typeof $!=="object"||typeof W!=="object"||Array.isArray($)!==Array.isArray(W))return W;if(Array.isArray($)){if(!G0($,W))return W;return}var X={},Y=Object.keys($),Z=Object.keys(W),Q,j,z={};for(j=0;j<Z.length;j++)if(Q=Z[j],Y.indexOf(Q)===-1)z[Q]=!0,X[Q]=K(W[Q]);var D={};for(j=0;j<Y.length;j++)if(Q=Y[j],Z.indexOf(Q)===-1)D[Q]=!0,X[Q]=null;else if($[Q]!==null&&typeof $[Q]==="object"){var B=J($[Q],W[Q]);if(B!==void 0)X[Q]=B}else if($[Q]!==W[Q])X[Q]=K(W[Q]);return Object.keys(X).length>0?X:void 0}});var j0=E((f0,Q0)=>{Q0.exports=function J($,W){if($===null||W===null||typeof $!=="object"||typeof W!=="object"||Array.isArray($)!==Array.isArray(W))return W;var X=JSON.parse(JSON.stringify($));return Object.keys(W).forEach(function(Y){if($[Y]!==void 0)X[Y]=J($[Y],W[Y]);else X[Y]=W[Y]}),X}});async function V(J,$){const W=await crypto.subtle.importKey("raw",typeof J==="string"?q.encode(J):J,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",W,q.encode($))}async function c(J){return crypto.subtle.digest("SHA-256",typeof J==="string"?q.encode(J):J)}var I=function(J){return Array.prototype.map.call(new Uint8Array(J),($)=>("0"+$.toString(16)).slice(-2)).join("")},n=function(J){return J.replace(/[!'()*]/g,($)=>"%"+$.charCodeAt(0).toString(16).toUpperCase())},_0=function(J,$){const{hostname:W,pathname:X}=J;if(W.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(W.endsWith(".backblazeb2.com")){const j=W.match(/^(?:[^.]+\.)?s3\.([^.]+)\.backblazeb2\.com$/);return j!=null?["s3",j[1]]:["",""]}const Y=W.replace("dualstack.","").match(/([^.]+)\.(?:([^.]*)\.)?amazonaws\.com(?:\.cn)?$/);let[Z,Q]=(Y||["",""]).slice(1,3);if(Q==="us-gov")Q="us-gov-west-1";else if(Q==="s3"||Q==="s3-accelerate")Q="us-east-1",Z="s3";else if(Z==="iot")if(W.startsWith("iot."))Z="execute-api";else if(W.startsWith("data.jobs.iot."))Z="iot-jobs-data";else Z=X==="/mqtt"?"iotdevicegateway":"iotdata";else if(Z==="autoscaling"){const j=($.get("X-Amz-Target")||"").split(".")[0];if(j==="AnyScaleFrontendService")Z="application-autoscaling";else if(j==="AnyScaleScalingPlannerFrontendService")Z="autoscaling-plans"}else if(Q==null&&Z.startsWith("s3-"))Q=Z.slice(3).replace(/^fips-|^external-1/,""),Z="s3";else if(Z.endsWith("-fips"))Z=Z.slice(0,-5);else if(Q&&/-\d$/.test(Z)&&!/-\d$/.test(Q))[Z,Q]=[Q,Z];return[L0[Z]||Z,Q]},q=new TextEncoder,L0={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},O0=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class R{constructor({accessKeyId:J,secretAccessKey:$,sessionToken:W,service:X,region:Y,cache:Z,retries:Q,initRetryMs:j}){if(J==null)throw new TypeError("accessKeyId is a required option");if($==null)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=J,this.secretAccessKey=$,this.sessionToken=W,this.service=X,this.region=Y,this.cache=Z||new Map,this.retries=Q!=null?Q:10,this.initRetryMs=j||50}async sign(J,$){if(J instanceof Request){const{method:Y,url:Z,headers:Q,body:j}=J;if($=Object.assign({method:Y,url:Z,headers:Q},$),$.body==null&&Q.has("Content-Type"))$.body=j!=null&&Q.has("X-Amz-Content-Sha256")?j:await J.clone().arrayBuffer();J=Z}const W=new i(Object.assign({url:J},$,this,$&&$.aws)),X=Object.assign({},$,await W.sign());delete X.aws;try{return new Request(X.url.toString(),X)}catch(Y){if(Y instanceof TypeError)return new Request(X.url.toString(),Object.assign({duplex:"half"},X));throw Y}}async fetch(J,$){for(let W=0;W<=this.retries;W++){const X=fetch(await this.sign(J,$));if(W===this.retries)return X;const Y=await X;if(Y.status<500&&Y.status!==429)return Y;await new Promise((Z)=>setTimeout(Z,Math.random()*this.initRetryMs*Math.pow(2,W)))}throw new Error("An unknown error occurred, ensure retries is not negative")}}class i{constructor({method:J,url:$,headers:W,body:X,accessKeyId:Y,secretAccessKey:Z,sessionToken:Q,service:j,region:z,cache:D,datetime:B,signQuery:O,appendSessionToken:x,allHeaders:F0,singleEncode:B0}){if($==null)throw new TypeError("url is a required option");if(Y==null)throw new TypeError("accessKeyId is a required option");if(Z==null)throw new TypeError("secretAccessKey is a required option");this.method=J||(X?"POST":"GET"),this.url=new URL($),this.headers=new Headers(W||{}),this.body=X,this.accessKeyId=Y,this.secretAccessKey=Z,this.sessionToken=Q;let p,y;if(!j||!z)[p,y]=_0(this.url,this.headers);if(this.service=j||p||"",this.region=z||y||"us-east-1",this.cache=D||new Map,this.datetime=B||(new Date()).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=O,this.appendSessionToken=x||this.service==="iotdevicegateway",this.headers.delete("Host"),this.service==="s3"&&!this.signQuery&&!this.headers.has("X-Amz-Content-Sha256"))this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const _=this.signQuery?this.url.searchParams:this.headers;if(_.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken)_.set("X-Amz-Security-Token",this.sessionToken);if(this.signableHeaders=["host",...this.headers.keys()].filter((F)=>F0||!O0.has(F)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map((F)=>F+":"+(F==="host"?this.url.host:(this.headers.get(F)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery){if(this.service==="s3"&&!_.has("X-Amz-Expires"))_.set("X-Amz-Expires","86400");_.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),_.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),_.set("X-Amz-SignedHeaders",this.signedHeaders)}if(this.service==="s3")try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(F){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");if(!B0)this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/");this.encodedPath=n(this.encodedPath);const u=new Set;this.encodedSearch=[...this.url.searchParams].filter(([F])=>{if(!F)return!1;if(this.service==="s3"){if(u.has(F))return!1;u.add(F)}return!0}).map((F)=>F.map((A)=>n(encodeURIComponent(A)))).sort(([F,A],[l,f])=>F<l?-1:F>l?1:A<f?-1:A>f?1:0).map((F)=>F.join("=")).join("&")}async sign(){if(this.signQuery){if(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken)this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)}else this.headers.set("Authorization",await this.authHeader());return{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const J=this.datetime.slice(0,8),$=[this.secretAccessKey,J,this.region,this.service].join();let W=this.cache.get($);if(!W){const X=await V("AWS4"+this.secretAccessKey,J),Y=await V(X,this.region),Z=await V(Y,this.service);W=await V(Z,"aws4_request"),this.cache.set($,W)}return I(await V(W,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,I(await c(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let J=this.headers.get("X-Amz-Content-Sha256")||(this.service==="s3"&&this.signQuery?"UNSIGNED-PAYLOAD":null);if(J==null){if(this.body&&typeof this.body!=="string"&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");J=I(await c(this.body||""))}return J}}var o=(J,$)=>{const W=$.parseFromString(J,"text/xml"),X=W.getElementsByTagName("ListBucketResult")[0],Y=W.getElementsByTagName("Contents"),Z=W.getElementsByTagName("CommonPrefixes")[0];if(!X||!Y)throw new Error(`Invalid XML: ${J}`);return{$metadata:{},IsTruncated:X.getElementsByTagName("IsTruncated")[0]?.textContent==="true",Contents:Array.from(Y).map((Q)=>({ChecksumAlgorithm:[Q.getElementsByTagName("ChecksumAlgorithm")[0]?.textContent],ETag:Q.getElementsByTagName("ETag")[0]?.textContent,Key:Q.getElementsByTagName("Key")[0]?.textContent,LastModified:new Date(Q.getElementsByTagName("LastModified")[0]?.textContent),Owner:{DisplayName:Q.getElementsByTagName("DisplayName")[0]?.textContent,ID:Q.getElementsByTagName("ID")[0]?.textContent},Size:Number.parseInt(Q.getElementsByTagName("Size")[0]?.textContent),StorageClass:Q.getElementsByTagName("StorageClass")[0]?.textContent})),Name:W.getElementsByTagName("Name")[0]?.textContent,Prefix:W.getElementsByTagName("Prefix")[0]?.textContent,Delimiter:W.getElementsByTagName("Delimiter")[0]?.textContent,MaxKeys:Number.parseInt(W.getElementsByTagName("MaxKeys")[0]?.textContent),CommonPrefixes:Array.from(Z?Z.getElementsByTagName("Prefix"):[],(Q)=>({Prefix:Q?.textContent})),EncodingType:W.getElementsByTagName("EncodingType")[0]?.textContent,KeyCount:Number.parseInt(W.getElementsByTagName("KeyCount")[0]?.textContent),ContinuationToken:W.getElementsByTagName("ContinuationToken")[0]?.textContent,NextContinuationToken:W.getElementsByTagName("NextContinuationToken")[0]?.textContent,StartAfter:W.getElementsByTagName("StartAfter")[0]?.textContent}};var M=async(J,{retries:$=Number.MAX_VALUE,delay:W=100}={})=>{try{return await J()}catch(X){if($>0)return await new Promise((Y)=>setTimeout(Y,W)),M(J,{retries:$-1,delay:W});throw X}};class S{J;$;W;constructor(J,$,W){this.fetch=J;this.endpoint=$;this.parser=W}getUrl(J,$,W){return`${this.endpoint}/${J}${$?`/${$}`:""}${W||""}`}async listObjectV2(J){for(let $=0;$<10;$++){const W=this.getUrl(J.Bucket,void 0,`/?list-type=2&prefix=${J.Prefix}`),X=await M(()=>this.fetch(W,{}));if(X.status===200)return o(await X.text(),this.parser);else if(X.status===429)console.warn("listObjectV2: 429, retrying"),await new Promise((Y)=>setTimeout(Y,1000));else throw new Error(`Unexpected response: ${X.status} ${await X.text()}`)}throw new Error("Cannot contact server")}async putObject({Bucket:J,Key:$,Body:W,ChecksumSHA256:X}){const Y=this.getUrl(J,$),Z=await M(()=>this.fetch(Y,{method:"PUT",body:W,headers:{"Content-Type":"application/json",...X&&{"x-amz-content-sha256":X}}}));if(Z.status!==200)throw new Error(`Failed to PUT: ${await Z.text()}`);return{$metadata:{httpStatusCode:Z.status},ETag:Z.headers.get("ETag"),...Z.headers.get("x-amz-version-id")&&{VersionId:Z.headers.get("x-amz-version-id")}}}async deleteObject({Bucket:J,Key:$}){return{$metadata:{httpStatusCode:(await M(()=>this.fetch(this.getUrl(J,$),{method:"DELETE"}))).status}}}async getObject({Bucket:J,Key:$,VersionId:W,IfNoneMatch:X}){const Y=this.getUrl(J,$,W?`?versionId=${W}`:""),Z=await M(()=>this.fetch(Y,{method:"GET",headers:{"If-None-Match":X}}));switch(Z.status){case 304:throw new Error("304");case 404:return{$metadata:{httpStatusCode:404}};case 403:throw new Error("Access denied");default:{let Q;const j=Z.headers.get("content-type"),z=await Z.text();if(j==="application/json"||z&&z!=="")try{Q=JSON.parse(z)}catch(D){throw new Error(`Failed to parse response as JSON ${Y}`)}return{$metadata:{httpStatusCode:Z.status},Body:Q,ETag:Z.headers.get("ETag"),...Z.headers.get("x-amz-version-id")&&{VersionId:Z.headers.get("x-amz-version-id")}}}}}}class P{key;_vals;_keys;constructor(J,$){if(this.key=J,this._vals=new Map,this._keys=new Map,$)for(let[W,X]of $)this.set(W,X)}get size(){return this._vals.size}set(J,$){const W=this.key(J);return this._vals.set(W,$),this._keys.set(W,J),this}get(J){return this._vals.get(this.key(J))}delete(J){const $=this.key(J);return this._keys.delete($),this._vals.delete($)}has(J){return this._vals.has(this.key(J))}values(){return this._vals.values()}keys(){return this._keys.values()}forEach(J){return this._vals.forEach(($,W,X)=>J($,this._keys.get(W)))}}var a=()=>`${Date.now()-200}`.padStart(14,"0"),s=()=>`${Date.now()+200}`.padStart(14,"0");var U=()=>crypto.randomUUID();var L=(J)=>`${J.bucket}/${J.key}`,H=(J,$)=>new URL(`${J}/${$.bucket}/${$.key}`);var C=function(J){return new Promise(($,W)=>{J.oncomplete=J.onsuccess=()=>$(J.result),J.onabort=J.onerror=()=>W(J.error)})},U0=function(J,$){const W=indexedDB.open(J);W.onupgradeneeded=()=>W.result.createObjectStore($);const X=C(W);return(Y,Z)=>X.then((Q)=>Z(Q.transaction($,Y).objectStore($)))},w=function(){if(!v)v=U0("keyval-store","keyval");return v},h=function(J,$=w()){return $("readonly",(W)=>C(W.get(J)))},b=function(J,$,W=w()){return W("readwrite",(X)=>{return X.put($,J),C(X.transaction)})};var G=function(J,$=w()){return $("readwrite",(W)=>{return W.delete(J),C(W.transaction)})};var H0=function(J,$){return J.openCursor().onsuccess=function(){if(!this.result)return;$(this.result),this.result.continue()},C(J.transaction)},t=function(J=w()){return J("readonly",($)=>{if($.getAllKeys)return C($.getAllKeys());const W=[];return H0($,(X)=>W.push(X.key)).then(()=>W)})};var v;var C0=6;class m{session=U();proposedOperations=new Map;operationLabels=new Map;db;lastIndex=0;constructor(J){this.db=J}async propose(J,$){if(this.proposedOperations.set(J,$),this.db){this.lastIndex++;const W=`entry-${this.lastIndex.toString().padStart(C0,"0")}`;J[this.session]=this.lastIndex,await b(W,[...$.entries()].map(([X,Y])=>[X.toString(),Y]),this.db)}}async label(J,$){if(this.operationLabels.set($,J),this.db){const W=J[this.session];if(W===void 0)throw new Error("Cannot label an unproposed operation");await b(`label-${W}`,$,this.db)}}async confirm(J){if(this.operationLabels.has(J)){const $=this.operationLabels.get(J);if(this.proposedOperations.delete($),this.operationLabels.delete(J),this.db){const W=$[this.session];await G(`entry-${W}`,this.db),await G(`label-${W}`,this.db)}}}async cancel(J){let $;if(this.operationLabels.forEach((W,X)=>{if(W===J)this.operationLabels.delete(X)}),this.proposedOperations.delete(J),this.db){const W=J[this.session];await G(`entry-${W}`,this.db),await G(`label-${W}`,this.db)}}flatten(){const J=new P(($)=>$.toString());return this.proposedOperations.forEach(($)=>{$.forEach((W,X)=>{J.set(X,W)})}),J}async restore(J,$){this.db=J,this.proposedOperations.clear(),this.operationLabels.clear(),this.lastIndex=0;const X=(await t(this.db)).filter((Y)=>Y.startsWith("entry-")).sort();for(let Y of X){const Z=parseInt(Y.split("-")[1]),Q=await h(Y,this.db),j=await h(`label-${Z}`,this.db);if(!Q)continue;const z=Q.map(([O,x])=>[new URL(O),x]),D=new Map(z),B=$(D);if(B[this.session]=Z,this.proposedOperations.set(B,D),j)this.label(B,j);this.lastIndex=Math.max(this.lastIndex,Z)}}}var N=$0(),N0=Z0(),T0=j0();var T={previous:".",files:{},update:{}};class z0{ref;handler;lastVersion;queue=Promise.resolve();constructor(J,$){this.ref=J,this.handler=$}notify(J,$,W){this.queue=this.queue.then(()=>W).then((X)=>{if($===this.lastVersion)return;else console.log(`${J} NOTIFY ${L(this.ref)} ${$}`),this.lastVersion=$,this.handler(X)})}}class k{service;ref;subscribers=new Set;poller;cache;pollInProgress=!1;authoritative_key="";authoritative_state=JSON.parse(JSON.stringify(T));optimistic_state=JSON.parse(JSON.stringify(T));operation_queue=new m;constructor(J,$,W){console.log("New manifest",$),this.service=J,this.ref=$}observeVersionId(J){this.operation_queue.confirm(J)}async get(){return this.getLatest().then((J)=>J||this.cache?.data)}async getLatest(){try{const J=await this.service._getObject({operation:"POLL_TIME",ref:this.ref,ifNoneMatch:this.cache?.etag});if(J.$metadata.httpStatusCode===304)return;if(J.data===void 0)this.authoritative_key=".";else this.authoritative_key=J.data;const $=await this.service.s3ClientLite.listObjectV2({Bucket:this.ref.bucket,Prefix:this.ref.key,StartAfter:this.authoritative_key});if($.Contents===void 0)return this.authoritative_state=JSON.parse(JSON.stringify(T)),this.optimistic_state=JSON.parse(JSON.stringify(T)),this.authoritative_state;const W=`${this.ref.key}@${a()}`;for(let X=$.Contents.length-1;X>=0;X--){const Y=$.Contents[X].Key;if(Y==this.ref.key)continue;const Z={bucket:this.ref.bucket,key:Y},Q=await this.service._getObject({operation:"LOOK_BACK",ref:Z});if(Q.data===void 0){await this.service._deleteObject({operation:"CLEANUP",ref:Z});continue}if(Q.data.previous<W){this.authoritative_key=Q.data.previous,this.authoritative_state=Q.data;break}}for(let X=0;X<$.Contents.length;X++){const Y=$.Contents[X].Key;if(Y==this.ref.key)continue;if(Y<this.authoritative_key)continue;const Z=await this.service._getObject({operation:"SWEEP",ref:{bucket:this.ref.bucket,key:Y}}),Q=Y.substring(Y.lastIndexOf("@")+1);if(Q>=W)console.log("Optimistic update"),this.optimistic_state=N(this.optimistic_state,Z.data?.update);else this.authoritative_state=N(this.authoritative_state,Z.data?.update),this.optimistic_state=N(this.optimistic_state,Z.data?.update),this.authoritative_key=Y;this.observeVersionId(Q)}return this.authoritative_state}catch(J){if(J.name==="NoSuchKey")return this.authoritative_state=T,this.authoritative_state;else throw J}}async poll(){if(this.pollInProgress)return;if(this.pollInProgress=!0,this.subscriberCount===0&&this.poller)clearInterval(this.poller),this.poller=void 0;if(this.subscriberCount>0&&!this.poller)this.poller=setInterval(()=>this.poll(),this.service.config.pollFrequency);const J=await this.getLatest();if(J===void 0){this.pollInProgress=!1;return}const $=this.operation_queue.flatten();this.subscribers.forEach(async(W)=>{if($.has(H(this.service.endpoint,W.ref)))W.notify(this.service.config.label,"local",Promise.resolve($.get(H(this.service.endpoint,W.ref))));else{const X=J.files[L(W.ref)];if(X){const Y=this.service._getObject({operation:"GET_CONTENT",ref:W.ref,version:X.version});W.notify(this.service.config.label,X.version,Y.then((Z)=>Z.data))}else if(X===null)W.notify(this.service.config.label,void 0,Promise.resolve(void 0))}}),this.pollInProgress=!1}async updateContent(J,$){this.operation_queue.propose($,J);try{const W=await $,X=await this.get();X.previous=this.authoritative_key,X.update={files:{}};for(let[j,z]of W){const D=L(j);if(z){const B={version:z};X.update.files[D]=B}else X.update.files[D]=null}const Y=s()+"_"+U().substring(0,2),Z=this.ref.key+"@"+Y;this.operation_queue.label($,Y),await this.service._putObject({operation:"PUT_MANIFEST",ref:{key:Z,bucket:this.ref.bucket},value:X});const Q=await this.service._putObject({operation:"PUT_POLL",ref:{key:this.ref.key,bucket:this.ref.bucket},value:this.authoritative_key});return this.poll(),Q}catch(W){throw console.error(W),this.operation_queue.cancel($),W}}async getOptimisticVersion(J){return await this.get(),this.optimistic_state.files[L(J)]?.version}subscribe(J,$){console.log(`SUBSCRIBE ${L(J)} ${this.subscriberCount+1}`);const W=new z0(J,$);return this.subscribers.add(W),()=>this.subscribers.delete(W)}get subscriberCount(){return this.subscribers.size}}async function D0(J){const $=(new TextEncoder()).encode(J),W=await crypto.subtle.digest("SHA-256",$);return[...new Uint8Array(W)].map((X)=>X.toString(16).padStart(2,"0")).join("")}class A0{config;s3ClientLite;manifests=new P(L);getCache=new P((J)=>`${J.Bucket}${J.Key}${J.VersionId}${J.IfNoneMatch}`);endpoint;constructor(J){if(this.config={...J,label:J.label||U().substring(0,3),useChecksum:J.useChecksum===!1?!1:!0,useVersioning:J.useVersioning||!1,pollFrequency:J.pollFrequency||1000,defaultManifest:{bucket:J.defaultManifest?.bucket||J.defaultBucket,key:typeof J.defaultManifest=="string"?J.defaultManifest:J.defaultManifest?.key||"manifest.json"}},this.config.s3Config?.credentials instanceof Function)throw Error("We can't do that yet");this.endpoint=J.s3Config.endpoint||`https://s3.${J.s3Config.region}.amazonaws.com`;let $;if(this.config.s3Config?.credentials){const W=new R({accessKeyId:this.config.s3Config.credentials.accessKeyId,secretAccessKey:this.config.s3Config.credentials.secretAccessKey,sessionToken:this.config.s3Config.credentials.sessionToken,region:this.config.s3Config.region||"us-east-1",service:"s3",retries:0});$=(...X)=>W.fetch(...X)}else $=(global||window).fetch.bind(global||window);this.s3ClientLite=new S($,this.endpoint,J.parser||new DOMParser)}getOrCreateManifest(J){if(!this.manifests.has(J))this.manifests.set(J,new k(this,J));return this.manifests.get(J)}async get(J,$={}){const W={...this.config.defaultManifest,...$.manifest},X=this.getOrCreateManifest(W),Y={bucket:J.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof J==="string"?J:J.key},Z=X.operation_queue.flatten(),Q=H(this.endpoint,Y);if(Z.has(Q))return console.log(`${this.config.label} get (cached) ${L(Y)}`),Z.get(Q);const j=await X.getOptimisticVersion(Y);if(j===void 0)return;return(await this._getObject({operation:"GET",ref:Y,version:j})).data}async _getObject(J){let $;if(this.config.useVersioning)$={Bucket:J.ref.bucket,Key:J.ref.key,IfNoneMatch:J.ifNoneMatch,...J.version&&{VersionId:J.version}};else $={Bucket:J.ref.bucket,Key:`${J.ref.key}${J.version?`@${J.version}`:""}`,IfNoneMatch:J.ifNoneMatch};if(this.getCache.has($))return await this.getCache.get($);const W=this.s3ClientLite.getObject($).then(async(X)=>{const Y={...X,data:X.Body};return console.log(`${this.config.label} ${J.operation} ${J.ref.bucket}/${J.ref.key}@${J.version} => ${Y.VersionId}`),this.getCache.set($,W),Y}).catch((X)=>{if(X?.name==="304")return{$metadata:{httpStatusCode:304},data:void 0};else throw X});return W}async delete(J,$={}){return this.putAll(new Map([[J,void 0]]),$)}async put(J,$,W={}){return this.putAll(new Map([[J,$]]),W)}async putAll(J,$={}){const W=new P(L,[...J].map(([Y,Z])=>[{bucket:Y.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof Y==="string"?Y:Y.key},Z])),X=($?.manifests||[this.config.defaultManifest]).map((Y)=>({...this.config.defaultManifest,...Y}));return this._putAll(W,{manifests:X})}async _putAll(J,$){const W=new Map,X=new Promise(async(Y,Z)=>{const Q=new Map,j=[];J.forEach((z,D)=>{if(z!==void 0){let B=this.config.useVersioning?void 0:U();W.set(H(this.endpoint,D),z),j.push(this._putObject({operation:"PUT_CONTENT",ref:D,value:z,version:B}).then((O)=>{if(this.config.useVersioning)if(O.VersionId===void 0)throw console.error(O),Error(`Bucket ${D.bucket} is not version enabled!`);else B=O.VersionId;Q.set(D,B)}))}else j.push(this._deleteObject({ref:D}).then((B)=>{Q.set(D,void 0)}))}),await Promise.all(j).catch(Z),Y(Q)});return Promise.all($.manifests.map((Y)=>{return this.getOrCreateManifest(Y).updateContent(W,X)}))}async _putObject(J){const $=JSON.stringify(J.value,null,2);let W;if(this.config.useVersioning)W={Bucket:J.ref.bucket,Key:J.ref.key,ContentType:"application/json",Body:$,...this.config.useChecksum&&{ChecksumSHA256:await D0($)}};else W={Bucket:J.ref.bucket,Key:`${J.ref.key}${J.version?`@${J.version}`:""}`,ContentType:"application/json",Body:$,...this.config.useChecksum&&{ChecksumSHA256:await D0($)}};const X=await this.s3ClientLite.putObject(W);return console.log(`${this.config.label} ${J.operation} ${W.Bucket}/${W.Key} => ${X.VersionId}`),X}async _deleteObject(J){const $={Bucket:J.ref.bucket,Key:J.ref.key},W=await this.s3ClientLite.deleteObject($);return console.log(`${this.config.label} ${J.operation||"DELETE"} ${J.ref.bucket}/${J.ref.key} => ${W.VersionId}`),W}subscribe(J,$,W){const X={...this.config.defaultManifest,...W?.manifest},Y={key:typeof J==="string"?J:J.key,bucket:J.bucket||this.config.defaultBucket||X.bucket},Z=this.getOrCreateManifest(X),Q=Z.subscribe(Y,$);return this.get(Y,{manifest:X}).then((j)=>{console.log(`${this.config.label} NOTIFY (initial) ${L(Y)}`),queueMicrotask(()=>{$(j),Z.poll()})}),Q}refresh(){return Promise.all([...this.manifests.values()].map((J)=>J.poll()))}get subscriberCount(){return[...this.manifests.values()].reduce((J,$)=>J+$.subscriberCount,0)}}export{A0 as MPS3};
