var _=($,J)=>()=>(J||$((J={exports:{}}).exports,J),J.exports);var h=_((V0,s)=>{V0.serialize=function($){return $&&typeof $.toJSON==="function"?$.toJSON():$}});var e=_((g0,r)=>{var t=h().serialize;r.exports=function $(J,W){if(W=t(W),W===null||typeof W!=="object"||Array.isArray(W))return W;if(J=t(J),J===null||typeof J!=="object"||Array.isArray(J))J={};var X=Object.keys(W);for(var Y=0;Y<X.length;Y++){var Z=X[Y];if(Z==="__proto__"||Z==="constructor"||Z==="prototype")return J;if(W[Z]===null){if(J.hasOwnProperty(Z))delete J[Z]}else J[Z]=$(J[Z],W[Z])}return J}});var J0=_((k0,$0)=>{$0.exports=function $(J,W){if(J===W)return!0;if(J&&W&&typeof J=="object"&&typeof W=="object"){if(J.constructor!==W.constructor)return!1;var X,Y,Z;if(Array.isArray(J)){if(X=J.length,X!=W.length)return!1;for(Y=X;Y--!==0;)if(!$(J[Y],W[Y]))return!1;return!0}if(J.constructor===RegExp)return J.source===W.source&&J.flags===W.flags;if(J.valueOf!==Object.prototype.valueOf)return J.valueOf()===W.valueOf();if(J.toString!==Object.prototype.toString)return J.toString()===W.toString();if(Z=Object.keys(J),X=Z.length,X!==Object.keys(W).length)return!1;for(Y=X;Y--!==0;)if(!Object.prototype.hasOwnProperty.call(W,Z[Y]))return!1;for(Y=X;Y--!==0;){var B=Z[Y];if(!$(J[B],W[B]))return!1}return!0}return J!==J&&W!==W}});var X0=_((d0,W0)=>{var E0=function($,J){if($.length!==J.length)return!1;for(var W=0;W<$.length;W++)if(!U0(J[W],$[W]))return!1;return!0},U0=J0(),x=h().serialize;W0.exports=function $(J,W){if(J=x(J),W=x(W),J===null||W===null||typeof J!=="object"||typeof W!=="object"||Array.isArray(J)!==Array.isArray(W))return W;if(Array.isArray(J)){if(!E0(J,W))return W;return}var X={},Y=Object.keys(J),Z=Object.keys(W),B,Q,D={};for(Q=0;Q<Z.length;Q++)if(B=Z[Q],Y.indexOf(B)===-1)D[B]=!0,X[B]=x(W[B]);var L={};for(Q=0;Q<Y.length;Q++)if(B=Y[Q],Z.indexOf(B)===-1)L[B]=!0,X[B]=null;else if(J[B]!==null&&typeof J[B]==="object"){var F=$(J[B],W[B]);if(F!==void 0)X[B]=F}else if(J[B]!==W[B])X[B]=x(W[B]);return Object.keys(X).length>0?X:void 0}});var Z0=_((p0,Y0)=>{Y0.exports=function $(J,W){if(J===null||W===null||typeof J!=="object"||typeof W!=="object"||Array.isArray(J)!==Array.isArray(W))return W;var X=JSON.parse(JSON.stringify(J));return Object.keys(W).forEach(function(Y){if(J[Y]!==void 0)X[Y]=$(J[Y],W[Y]);else X[Y]=W[Y]}),X}});async function U($,J){const W=await crypto.subtle.importKey("raw",typeof $==="string"?T.encode($):$,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",W,T.encode(J))}async function y($){return crypto.subtle.digest("SHA-256",typeof $==="string"?T.encode($):$)}var K=function($){return Array.prototype.map.call(new Uint8Array($),(J)=>("0"+J.toString(16)).slice(-2)).join("")},l=function($){return $.replace(/[!'()*]/g,(J)=>"%"+J.charCodeAt(0).toString(16).toUpperCase())},j0=function($,J){const{hostname:W,pathname:X}=$;if(W.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(W.endsWith(".backblazeb2.com")){const Q=W.match(/^(?:[^.]+\.)?s3\.([^.]+)\.backblazeb2\.com$/);return Q!=null?["s3",Q[1]]:["",""]}const Y=W.replace("dualstack.","").match(/([^.]+)\.(?:([^.]*)\.)?amazonaws\.com(?:\.cn)?$/);let[Z,B]=(Y||["",""]).slice(1,3);if(B==="us-gov")B="us-gov-west-1";else if(B==="s3"||B==="s3-accelerate")B="us-east-1",Z="s3";else if(Z==="iot")if(W.startsWith("iot."))Z="execute-api";else if(W.startsWith("data.jobs.iot."))Z="iot-jobs-data";else Z=X==="/mqtt"?"iotdevicegateway":"iotdata";else if(Z==="autoscaling"){const Q=(J.get("X-Amz-Target")||"").split(".")[0];if(Q==="AnyScaleFrontendService")Z="application-autoscaling";else if(Q==="AnyScaleScalingPlannerFrontendService")Z="autoscaling-plans"}else if(B==null&&Z.startsWith("s3-"))B=Z.slice(3).replace(/^fips-|^external-1/,""),Z="s3";else if(Z.endsWith("-fips"))Z=Z.slice(0,-5);else if(B&&/-\d$/.test(Z)&&!/-\d$/.test(B))[Z,B]=[B,Z];return[F0[Z]||Z,B]},T=new TextEncoder,F0={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},H0=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class w{constructor({accessKeyId:$,secretAccessKey:J,sessionToken:W,service:X,region:Y,cache:Z,retries:B,initRetryMs:Q}){if($==null)throw new TypeError("accessKeyId is a required option");if(J==null)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=$,this.secretAccessKey=J,this.sessionToken=W,this.service=X,this.region=Y,this.cache=Z||new Map,this.retries=B!=null?B:10,this.initRetryMs=Q||50}async sign($,J){if($ instanceof Request){const{method:Y,url:Z,headers:B,body:Q}=$;if(J=Object.assign({method:Y,url:Z,headers:B},J),J.body==null&&B.has("Content-Type"))J.body=Q!=null&&B.has("X-Amz-Content-Sha256")?Q:await $.clone().arrayBuffer();$=Z}const W=new u(Object.assign({url:$},J,this,J&&J.aws)),X=Object.assign({},J,await W.sign());delete X.aws;try{return new Request(X.url.toString(),X)}catch(Y){if(Y instanceof TypeError)return new Request(X.url.toString(),Object.assign({duplex:"half"},X));throw Y}}async fetch($,J){for(let W=0;W<=this.retries;W++){const X=fetch(await this.sign($,J));if(W===this.retries)return X;const Y=await X;if(Y.status<500&&Y.status!==429)return Y;await new Promise((Z)=>setTimeout(Z,Math.random()*this.initRetryMs*Math.pow(2,W)))}throw new Error("An unknown error occurred, ensure retries is not negative")}}class u{constructor({method:$,url:J,headers:W,body:X,accessKeyId:Y,secretAccessKey:Z,sessionToken:B,service:Q,region:D,cache:L,datetime:F,signQuery:V,appendSessionToken:z0,allHeaders:L0,singleEncode:D0}){if(J==null)throw new TypeError("url is a required option");if(Y==null)throw new TypeError("accessKeyId is a required option");if(Z==null)throw new TypeError("secretAccessKey is a required option");this.method=$||(X?"POST":"GET"),this.url=new URL(J),this.headers=new Headers(W||{}),this.body=X,this.accessKeyId=Y,this.secretAccessKey=Z,this.sessionToken=B;let g,k;if(!Q||!D)[g,k]=j0(this.url,this.headers);if(this.service=Q||g||"",this.region=D||k||"us-east-1",this.cache=L||new Map,this.datetime=F||(new Date()).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=V,this.appendSessionToken=z0||this.service==="iotdevicegateway",this.headers.delete("Host"),this.service==="s3"&&!this.signQuery&&!this.headers.has("X-Amz-Content-Sha256"))this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const O=this.signQuery?this.url.searchParams:this.headers;if(O.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken)O.set("X-Amz-Security-Token",this.sessionToken);if(this.signableHeaders=["host",...this.headers.keys()].filter((z)=>L0||!H0.has(z)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map((z)=>z+":"+(z==="host"?this.url.host:(this.headers.get(z)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery){if(this.service==="s3"&&!O.has("X-Amz-Expires"))O.set("X-Amz-Expires","86400");O.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),O.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),O.set("X-Amz-SignedHeaders",this.signedHeaders)}if(this.service==="s3")try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(z){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");if(!D0)this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/");this.encodedPath=l(this.encodedPath);const d=new Set;this.encodedSearch=[...this.url.searchParams].filter(([z])=>{if(!z)return!1;if(this.service==="s3"){if(d.has(z))return!1;d.add(z)}return!0}).map((z)=>z.map((G)=>l(encodeURIComponent(G)))).sort(([z,G],[p,m])=>z<p?-1:z>p?1:G<m?-1:G>m?1:0).map((z)=>z.join("=")).join("&")}async sign(){if(this.signQuery){if(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken)this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)}else this.headers.set("Authorization",await this.authHeader());return{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const $=this.datetime.slice(0,8),J=[this.secretAccessKey,$,this.region,this.service].join();let W=this.cache.get(J);if(!W){const X=await U("AWS4"+this.secretAccessKey,$),Y=await U(X,this.region),Z=await U(Y,this.service);W=await U(Z,"aws4_request"),this.cache.set(J,W)}return K(await U(W,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,K(await y(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let $=this.headers.get("X-Amz-Content-Sha256")||(this.service==="s3"&&this.signQuery?"UNSIGNED-PAYLOAD":null);if($==null){if(this.body&&typeof this.body!=="string"&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");$=K(await y(this.body||""))}return $}}var f=($,J)=>{const W=J.parseFromString($,"text/xml"),X=W.getElementsByTagName("ListBucketResult")[0],Y=W.getElementsByTagName("Contents"),Z=W.getElementsByTagName("CommonPrefixes")[0];if(!X||!Y)throw new Error(`Invalid XML: ${$}`);return{$metadata:{},IsTruncated:X.getElementsByTagName("IsTruncated")[0]?.textContent==="true",Contents:Array.from(Y).map((B)=>({ChecksumAlgorithm:[B.getElementsByTagName("ChecksumAlgorithm")[0]?.textContent],ETag:B.getElementsByTagName("ETag")[0]?.textContent,Key:B.getElementsByTagName("Key")[0]?.textContent,LastModified:new Date(B.getElementsByTagName("LastModified")[0]?.textContent),Owner:{DisplayName:B.getElementsByTagName("DisplayName")[0]?.textContent,ID:B.getElementsByTagName("ID")[0]?.textContent},Size:Number.parseInt(B.getElementsByTagName("Size")[0]?.textContent),StorageClass:B.getElementsByTagName("StorageClass")[0]?.textContent})),Name:W.getElementsByTagName("Name")[0]?.textContent,Prefix:W.getElementsByTagName("Prefix")[0]?.textContent,Delimiter:W.getElementsByTagName("Delimiter")[0]?.textContent,MaxKeys:Number.parseInt(W.getElementsByTagName("MaxKeys")[0]?.textContent),CommonPrefixes:Array.from(Z?Z.getElementsByTagName("Prefix"):[],(B)=>({Prefix:B?.textContent})),EncodingType:W.getElementsByTagName("EncodingType")[0]?.textContent,KeyCount:Number.parseInt(W.getElementsByTagName("KeyCount")[0]?.textContent),ContinuationToken:W.getElementsByTagName("ContinuationToken")[0]?.textContent,NextContinuationToken:W.getElementsByTagName("NextContinuationToken")[0]?.textContent,StartAfter:W.getElementsByTagName("StartAfter")[0]?.textContent}};class I{client;endpoint;parser;constructor($,J,W){this.client=$,this.endpoint=J,this.parser=W}async listObjectV2($){for(let J=0;J<10;J++){const W=`${this.endpoint}/${$.Bucket}/?list-type=2&prefix=${$.Prefix}`,X=await this.client(W,{});if(X.status===200){const Y=await X.text();return f(Y,this.parser)}else if(X.status===429)console.warn("listObjectV2: 429, retrying"),await new Promise((Y)=>setTimeout(Y,1000));else throw new Error(`Unexpected response: ${X.status} ${X.text()}`)}throw new Error("Cannot contact server")}async putObject($){const J=`${this.endpoint}/${$.Bucket}/${$.Key}`,W=await this.client(J,{method:"PUT",body:$.Body,headers:{"Content-Type":"application/json",...$.ChecksumSHA256&&{"x-amz-content-sha256":$.ChecksumSHA256}}});if(W.status!=200)throw new Error(`Failed to PUT: ${await W.text()}`);return{$metadata:{httpStatusCode:W.status},ETag:W.headers.get("ETag"),...W.headers.get("x-amz-version-id")&&{VersionId:W.headers.get("x-amz-version-id")}}}async deleteObject($){const J=`${this.endpoint}/${$.Bucket}/${$.Key}`;return{$metadata:{httpStatusCode:(await this.client(J,{method:"DELETE"})).status}}}async getObject($){const J=`${this.endpoint}/${$.Bucket}/${$.Key}?${$.VersionId?`versionId=${$.VersionId}`:""}`,W=await this.client(J,{method:"GET",headers:{"If-None-Match":$.IfNoneMatch}});if(W.status==304){const Y=new Error;throw Y.name="304",Y}let X;if(W.status==404)X=void 0;else if(W.status==403)throw new Error("Access denied");else if(W.headers.get("content-type")==="application/json")X=await W.json();else{const Y=await W.text();if(Y==="")X=void 0;else try{X=JSON.parse(Y)}catch(Z){throw new Error(`Failed to parse response as JSON ${J}`)}}return{$metadata:{httpStatusCode:W.status},Body:X,ETag:W.headers.get("ETag"),...W.headers.get("x-amz-version-id")&&{VersionId:W.headers.get("x-amz-version-id")}}}}class j{key;_vals;_keys;constructor($,J){if(this.key=$,this._vals=new Map,this._keys=new Map,J)for(let[W,X]of J)this.set(W,X)}get size(){return this._vals.size}set($,J){const W=this.key($);return this._vals.set(W,J),this._keys.set(W,$),this}get($){return this._vals.get(this.key($))}delete($){const J=this.key($);return this._keys.delete(J),this._vals.delete(J)}has($){return this._vals.has(this.key($))}values(){return this._vals.values()}keys(){return this._keys.values()}forEach($){return this._vals.forEach((J,W,X)=>$(J,this._keys.get(W)))}}var c=()=>`${Date.now()-200}`.padStart(14,"0"),i=()=>`${Date.now()+200}`.padStart(14,"0");var P=function($){return new Promise((J,W)=>{$.oncomplete=$.onsuccess=()=>J($.result),$.onabort=$.onerror=()=>W($.error)})},P0=function($,J){const W=indexedDB.open($);W.onupgradeneeded=()=>W.result.createObjectStore(J);const X=P(W);return(Y,Z)=>X.then((B)=>Z(B.transaction(J,Y).objectStore(J)))},A=function(){if(!q)q=P0("keyval-store","keyval");return q},n=function($,J=A()){return J("readonly",(W)=>P(W.get($)))},o=function($,J,W=A()){return W("readwrite",(X)=>{return X.put(J,$),P(X.transaction)})};var R=function($,J=A()){return J("readwrite",(W)=>{return W.delete($),P(W.transaction)})};var C0=function($,J){return $.openCursor().onsuccess=function(){if(!this.result)return;J(this.result),this.result.continue()},P($.transaction)},a=function($=A()){return $("readonly",(J)=>{if(J.getAllKeys)return P(J.getAllKeys());const W=[];return C0(J,(X)=>W.push(X.key)).then(()=>W)})};var q;class S{proposedOperations=new Map;operationLabels=new Map;db;lastIndex=0;async propose($,J){if(this.proposedOperations.set($,J),this.db){this.lastIndex++;const W=`entry-${this.lastIndex}`;await o(W,J,this.db)}}async label($,J){const W=this.db?`entry-${this.lastIndex}`:void 0;this.operationLabels.set(J,[$,W])}async confirm($){if(this.operationLabels.has($)){const[J,W]=this.operationLabels.get($);if(this.proposedOperations.delete(J),this.operationLabels.delete($),W&&this.db)await R(W,this.db)}}async cancel($){let J;if(this.operationLabels.forEach((W,X)=>{if(W[0]===$)J=W[1],this.operationLabels.delete(X)}),this.proposedOperations.delete($),J&&this.db)await R(J,this.db)}flatten(){const $=new j((J)=>J.toString());return this.proposedOperations.forEach((J)=>{J.forEach((W,X)=>{$.set(X,W)})}),$}async restore($,J){this.db=$;const X=(await a(this.db)).filter((Y)=>Y.startsWith("entry-")).sort();for(let Y of X){const Z=await n(Y,this.db),B=J(Z);this.propose(B,Z),this.lastIndex=Math.max(this.lastIndex,parseInt(Y.split("-")[1]))}}}var E=()=>crypto.randomUUID();var H=($)=>`${$.bucket}/${$.key}`,C=($,J)=>new URL(`${$}/${J.bucket}/${J.key}`);var M=e(),M0=X0(),N0=Z0();var N={previous:".",files:{},update:{}};class B0{ref;handler;lastVersion;queue=Promise.resolve();constructor($,J){this.ref=$,this.handler=J}notify($,J,W){this.queue=this.queue.then(()=>W).then((X)=>{if(J===this.lastVersion)return;else console.log(`${$} NOTIFY ${H(this.ref)} ${J}`),this.lastVersion=J,this.handler(X)})}}class b{service;ref;subscribers=new Set;poller;cache;pollInProgress=!1;authoritative_key="";authoritative_state=JSON.parse(JSON.stringify(N));optimistic_state=JSON.parse(JSON.stringify(N));operation_queue=new S;constructor($,J,W){console.log("New manifest",J),this.service=$,this.ref=J}observeVersionId($){this.operation_queue.confirm($)}async get(){return this.getLatest().then(($)=>$||this.cache?.data)}async getLatest(){try{const $=await this.service._getObject({operation:"POLL_TIME",ref:this.ref,ifNoneMatch:this.cache?.etag});if($.$metadata.httpStatusCode===304)return;if($.data===void 0)this.authoritative_key=".";else this.authoritative_key=$.data;const J=await this.service.s3ClientLite.listObjectV2({Bucket:this.ref.bucket,Prefix:this.ref.key,StartAfter:this.authoritative_key});if(J.Contents===void 0)return this.authoritative_state=JSON.parse(JSON.stringify(N)),this.optimistic_state=JSON.parse(JSON.stringify(N)),this.authoritative_state;const W=`${this.ref.key}@${c()}`;for(let X=J.Contents.length-1;X>=0;X--){const Y=J.Contents[X].Key;if(Y==this.ref.key)continue;const Z={bucket:this.ref.bucket,key:Y},B=await this.service._getObject({operation:"LOOK_BACK",ref:Z});if(B.data===void 0){await this.service._deleteObject({operation:"CLEANUP",ref:Z});continue}if(B.data.previous<W){this.authoritative_key=B.data.previous,this.authoritative_state=B.data;break}}for(let X=0;X<J.Contents.length;X++){const Y=J.Contents[X].Key;if(Y==this.ref.key)continue;if(Y<this.authoritative_key)continue;const Z=await this.service._getObject({operation:"SWEEP",ref:{bucket:this.ref.bucket,key:Y}}),B=Y.substring(Y.lastIndexOf("@")+1);if(B>=W)console.log("Optimistic update"),this.optimistic_state=M(this.optimistic_state,Z.data?.update);else this.authoritative_state=M(this.authoritative_state,Z.data?.update),this.optimistic_state=M(this.optimistic_state,Z.data?.update),this.authoritative_key=Y;this.observeVersionId(B)}return this.authoritative_state}catch($){if($.name==="NoSuchKey")return this.authoritative_state=N,this.authoritative_state;else throw $}}async poll(){if(this.pollInProgress)return;if(this.pollInProgress=!0,this.subscriberCount===0&&this.poller)clearInterval(this.poller),this.poller=void 0;if(this.subscriberCount>0&&!this.poller)this.poller=setInterval(()=>this.poll(),this.service.config.pollFrequency);const $=await this.getLatest();if($===void 0){this.pollInProgress=!1;return}const J=this.operation_queue.flatten();this.subscribers.forEach(async(W)=>{if(J.has(C(this.service.endpoint,W.ref)))W.notify(this.service.config.label,"local",Promise.resolve(J.get(C(this.service.endpoint,W.ref))));else{const X=$.files[H(W.ref)];if(X){const Y=this.service._getObject({operation:"GET_CONTENT",ref:W.ref,version:X.version});W.notify(this.service.config.label,X.version,Y.then((Z)=>Z.data))}else if(X===null)W.notify(this.service.config.label,void 0,Promise.resolve(void 0))}}),this.pollInProgress=!1}async updateContent($,J){this.operation_queue.propose(J,$);try{const W=await J,X=await this.get();X.previous=this.authoritative_key,X.update={files:{}};for(let[Q,D]of W){const L=H(Q);if(D){const F={version:D};X.update.files[L]=F}else X.update.files[L]=null}const Y=i()+"_"+E().substring(0,2),Z=this.ref.key+"@"+Y;this.operation_queue.label(J,Y),await this.service._putObject({operation:"PUT_MANIFEST",ref:{key:Z,bucket:this.ref.bucket},value:X});const B=await this.service._putObject({operation:"PUT_POLL",ref:{key:this.ref.key,bucket:this.ref.bucket},value:this.authoritative_key});return this.poll(),B}catch(W){throw console.error(W),this.operation_queue.cancel(J),W}}async getOptimisticVersion($){return await this.get(),this.optimistic_state.files[H($)]?.version}subscribe($,J){console.log(`SUBSCRIBE ${H($)} ${this.subscriberCount+1}`);const W=new B0($,J);return this.subscribers.add(W),()=>this.subscribers.delete(W)}get subscriberCount(){return this.subscribers.size}}async function Q0($){const J=(new TextEncoder()).encode($),W=await crypto.subtle.digest("SHA-256",J);return[...new Uint8Array(W)].map((X)=>X.toString(16).padStart(2,"0")).join("")}class G0{config;s3ClientLite;manifests=new j(H);getCache=new j(($)=>`${$.Bucket}${$.Key}${$.VersionId}${$.IfNoneMatch}`);endpoint;constructor($){if(this.config={...$,label:$.label||E().substring(0,3),useChecksum:$.useChecksum===!1?!1:!0,useVersioning:$.useVersioning||!1,pollFrequency:$.pollFrequency||1000,defaultManifest:{bucket:$.defaultManifest?.bucket||$.defaultBucket,key:typeof $.defaultManifest=="string"?$.defaultManifest:$.defaultManifest?.key||"manifest.json"}},this.config.s3Config?.credentials instanceof Function)throw Error("We can't do that yet");this.endpoint=$.s3Config.endpoint||`https://s3.${$.s3Config.region}.amazonaws.com`;let J;if(this.config.s3Config?.credentials){const W=new w({accessKeyId:this.config.s3Config.credentials.accessKeyId,secretAccessKey:this.config.s3Config.credentials.secretAccessKey,sessionToken:this.config.s3Config.credentials.sessionToken,region:this.config.s3Config.region||"us-east-1",service:"s3",retries:0});J=(...X)=>W.fetch(...X)}else J=(global||window).fetch.bind(global||window);this.s3ClientLite=new I(J,this.endpoint,$.parser||new DOMParser)}getOrCreateManifest($){if(!this.manifests.has($))this.manifests.set($,new b(this,$));return this.manifests.get($)}async get($,J={}){const W={...this.config.defaultManifest,...J.manifest},X=this.getOrCreateManifest(W),Y={bucket:$.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof $==="string"?$:$.key},Z=X.operation_queue.flatten(),B=C(this.endpoint,Y);if(Z.has(B))return console.log(`${this.config.label} get (cached) ${H(Y)}`),Z.get(B);const Q=await X.getOptimisticVersion(Y);if(Q===void 0)return;return(await this._getObject({operation:"GET",ref:Y,version:Q})).data}async _getObject($){let J;if(this.config.useVersioning)J={Bucket:$.ref.bucket,Key:$.ref.key,IfNoneMatch:$.ifNoneMatch,...$.version&&{VersionId:$.version}};else J={Bucket:$.ref.bucket,Key:`${$.ref.key}${$.version?`@${$.version}`:""}`,IfNoneMatch:$.ifNoneMatch};if(this.getCache.has(J))return await this.getCache.get(J);const W=this.s3ClientLite.getObject(J).then(async(X)=>{const Y={...X,data:X.Body};return console.log(`${this.config.label} ${$.operation} ${$.ref.bucket}/${$.ref.key}@${$.version} => ${Y.VersionId}`),this.getCache.set(J,W),Y}).catch((X)=>{if(X?.name==="304")return{$metadata:{httpStatusCode:304},data:void 0};else throw X});return W}async delete($,J={}){return this.putAll(new Map([[$,void 0]]),J)}async put($,J,W={}){return this.putAll(new Map([[$,J]]),W)}async putAll($,J={}){const W=new j(H,[...$].map(([Y,Z])=>[{bucket:Y.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof Y==="string"?Y:Y.key},Z])),X=(J?.manifests||[this.config.defaultManifest]).map((Y)=>({...this.config.defaultManifest,...Y}));return this._putAll(W,{manifests:X})}async _putAll($,J){const W=new j((Y)=>Y.toString()),X=new Promise(async(Y,Z)=>{const B=new Map,Q=[];$.forEach((D,L)=>{if(D!==void 0){let F=this.config.useVersioning?void 0:E();W.set(C(this.endpoint,L),D),Q.push(this._putObject({operation:"PUT_CONTENT",ref:L,value:D,version:F}).then((V)=>{if(this.config.useVersioning)if(V.VersionId===void 0)throw console.error(V),Error(`Bucket ${L.bucket} is not version enabled!`);else F=V.VersionId;B.set(L,F)}))}else Q.push(this._deleteObject({ref:L}).then((F)=>{B.set(L,void 0)}))}),await Promise.all(Q).catch(Z),Y(B)});return Promise.all(J.manifests.map((Y)=>{return this.getOrCreateManifest(Y).updateContent(W,X)}))}async _putObject($){const J=JSON.stringify($.value,null,2);let W;if(this.config.useVersioning)W={Bucket:$.ref.bucket,Key:$.ref.key,ContentType:"application/json",Body:J,...this.config.useChecksum&&{ChecksumSHA256:await Q0(J)}};else W={Bucket:$.ref.bucket,Key:`${$.ref.key}${$.version?`@${$.version}`:""}`,ContentType:"application/json",Body:J,...this.config.useChecksum&&{ChecksumSHA256:await Q0(J)}};const X=await this.s3ClientLite.putObject(W);return console.log(`${this.config.label} ${$.operation} ${W.Bucket}/${W.Key} => ${X.VersionId}`),X}async _deleteObject($){const J={Bucket:$.ref.bucket,Key:$.ref.key},W=await this.s3ClientLite.deleteObject(J);return console.log(`${this.config.label} ${$.operation||"DELETE"} ${$.ref.bucket}/${$.ref.key} => ${W.VersionId}`),W}subscribe($,J,W){const X={...this.config.defaultManifest,...W?.manifest},Y={key:typeof $==="string"?$:$.key,bucket:$.bucket||this.config.defaultBucket||X.bucket},Z=this.getOrCreateManifest(X),B=Z.subscribe(Y,J);return this.get(Y,{manifest:X}).then((Q)=>{console.log(`${this.config.label} NOTIFY (initial) ${H(Y)}`),queueMicrotask(()=>{J(Q),Z.poll()})}),B}refresh(){return Promise.all([...this.manifests.values()].map(($)=>$.poll()))}get subscriberCount(){return[...this.manifests.values()].reduce(($,J)=>$+J.subscriberCount,0)}}export{G0 as MPS3};
