var q=($,W)=>()=>(W||$((W={exports:{}}).exports,W),W.exports);var T=q((Z0,l)=>{Z0.serialize=function($){return $&&typeof $.toJSON==="function"?$.toJSON():$}});var f=q((_0,p)=>{var d=T().serialize;p.exports=function $(W,X){if(X=d(X),X===null||typeof X!=="object"||Array.isArray(X))return X;if(W=d(W),W===null||typeof W!=="object"||Array.isArray(W))W={};var B=Object.keys(X);for(var D=0;D<B.length;D++){var J=B[D];if(J==="__proto__"||J==="constructor"||J==="prototype")return W;if(X[J]===null){if(W.hasOwnProperty(J))delete W[J]}else W[J]=$(W[J],X[J])}return W}});var c=q((C0,o)=>{o.exports=function $(W,X){if(W===X)return!0;if(W&&X&&typeof W=="object"&&typeof X=="object"){if(W.constructor!==X.constructor)return!1;var B,D,J;if(Array.isArray(W)){if(B=W.length,B!=X.length)return!1;for(D=B;D--!==0;)if(!$(W[D],X[D]))return!1;return!0}if(W.constructor===RegExp)return W.source===X.source&&W.flags===X.flags;if(W.valueOf!==Object.prototype.valueOf)return W.valueOf()===X.valueOf();if(W.toString!==Object.prototype.toString)return W.toString()===X.toString();if(J=Object.keys(W),B=J.length,B!==Object.keys(X).length)return!1;for(D=B;D--!==0;)if(!Object.prototype.hasOwnProperty.call(X,J[D]))return!1;for(D=B;D--!==0;){var Y=J[D];if(!$(W[Y],X[Y]))return!1}return!0}return W!==W&&X!==X}});var n=q((E0,i)=>{var Q0=function($,W){if($.length!==W.length)return!1;for(var X=0;X<$.length;X++)if(!G0(W[X],$[X]))return!1;return!0},G0=c(),V=T().serialize;i.exports=function $(W,X){if(W=V(W),X=V(X),W===null||X===null||typeof W!=="object"||typeof X!=="object"||Array.isArray(W)!==Array.isArray(X))return X;if(Array.isArray(W)){if(!Q0(W,X))return X;return}var B={},D=Object.keys(W),J=Object.keys(X),Y,Z,G={};for(Z=0;Z<J.length;Z++)if(Y=J[Z],D.indexOf(Y)===-1)G[Y]=!0,B[Y]=V(X[Y]);var z={};for(Z=0;Z<D.length;Z++)if(Y=D[Z],J.indexOf(Y)===-1)z[Y]=!0,B[Y]=null;else if(W[Y]!==null&&typeof W[Y]==="object"){var N=$(W[Y],X[Y]);if(N!==void 0)B[Y]=N}else if(W[Y]!==X[Y])B[Y]=V(X[Y]);return Object.keys(B).length>0?B:void 0}});var s=q((w0,t)=>{t.exports=function $(W,X){if(W===null||X===null||typeof W!=="object"||typeof X!=="object"||Array.isArray(W)!==Array.isArray(X))return X;var B=JSON.parse(JSON.stringify(W));return Object.keys(X).forEach(function(D){if(W[D]!==void 0)B[D]=$(W[D],X[D]);else B[D]=X[D]}),B}});async function H($,W){const X=await crypto.subtle.importKey("raw",typeof $==="string"?C.encode($):$,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",X,C.encode(W))}async function b($){return crypto.subtle.digest("SHA-256",typeof $==="string"?C.encode($):$)}var _=function($){return Array.prototype.map.call(new Uint8Array($),(W)=>("0"+W.toString(16)).slice(-2)).join("")},u=function($){return $.replace(/[!'()*]/g,(W)=>"%"+W.charCodeAt(0).toString(16).toUpperCase())},J0=function($,W){const{hostname:X,pathname:B}=$;if(X.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(X.endsWith(".backblazeb2.com")){const Z=X.match(/^(?:[^.]+\.)?s3\.([^.]+)\.backblazeb2\.com$/);return Z!=null?["s3",Z[1]]:["",""]}const D=X.replace("dualstack.","").match(/([^.]+)\.(?:([^.]*)\.)?amazonaws\.com(?:\.cn)?$/);let[J,Y]=(D||["",""]).slice(1,3);if(Y==="us-gov")Y="us-gov-west-1";else if(Y==="s3"||Y==="s3-accelerate")Y="us-east-1",J="s3";else if(J==="iot")if(X.startsWith("iot."))J="execute-api";else if(X.startsWith("data.jobs.iot."))J="iot-jobs-data";else J=B==="/mqtt"?"iotdevicegateway":"iotdata";else if(J==="autoscaling"){const Z=(W.get("X-Amz-Target")||"").split(".")[0];if(Z==="AnyScaleFrontendService")J="application-autoscaling";else if(Z==="AnyScaleScalingPlannerFrontendService")J="autoscaling-plans"}else if(Y==null&&J.startsWith("s3-"))Y=J.slice(3).replace(/^fips-|^external-1/,""),J="s3";else if(J.endsWith("-fips"))J=J.slice(0,-5);else if(Y&&/-\d$/.test(J)&&!/-\d$/.test(Y))[J,Y]=[Y,J];return[B0[J]||J,Y]},C=new TextEncoder,B0={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},D0=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class E{constructor({accessKeyId:$,secretAccessKey:W,sessionToken:X,service:B,region:D,cache:J,retries:Y,initRetryMs:Z}){if($==null)throw new TypeError("accessKeyId is a required option");if(W==null)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=$,this.secretAccessKey=W,this.sessionToken=X,this.service=B,this.region=D,this.cache=J||new Map,this.retries=Y!=null?Y:10,this.initRetryMs=Z||50}async sign($,W){if($ instanceof Request){const{method:D,url:J,headers:Y,body:Z}=$;if(W=Object.assign({method:D,url:J,headers:Y},W),W.body==null&&Y.has("Content-Type"))W.body=Z!=null&&Y.has("X-Amz-Content-Sha256")?Z:await $.clone().arrayBuffer();$=J}const X=new k(Object.assign({url:$},W,this,W&&W.aws)),B=Object.assign({},W,await X.sign());delete B.aws;try{return new Request(B.url.toString(),B)}catch(D){if(D instanceof TypeError)return new Request(B.url.toString(),Object.assign({duplex:"half"},B));throw D}}async fetch($,W){for(let X=0;X<=this.retries;X++){const B=fetch(await this.sign($,W));if(X===this.retries)return B;const D=await B;if(D.status<500&&D.status!==429)return D;await new Promise((J)=>setTimeout(J,Math.random()*this.initRetryMs*Math.pow(2,X)))}throw new Error("An unknown error occurred, ensure retries is not negative")}}class k{constructor({method:$,url:W,headers:X,body:B,accessKeyId:D,secretAccessKey:J,sessionToken:Y,service:Z,region:G,cache:z,datetime:N,signQuery:e,appendSessionToken:$0,allHeaders:W0,singleEncode:X0}){if(W==null)throw new TypeError("url is a required option");if(D==null)throw new TypeError("accessKeyId is a required option");if(J==null)throw new TypeError("secretAccessKey is a required option");this.method=$||(B?"POST":"GET"),this.url=new URL(W),this.headers=new Headers(X||{}),this.body=B,this.accessKeyId=D,this.secretAccessKey=J,this.sessionToken=Y;let S,I;if(!Z||!G)[S,I]=J0(this.url,this.headers);if(this.service=Z||S||"",this.region=G||I||"us-east-1",this.cache=z||new Map,this.datetime=N||(new Date()).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=e,this.appendSessionToken=$0||this.service==="iotdevicegateway",this.headers.delete("Host"),this.service==="s3"&&!this.signQuery&&!this.headers.has("X-Amz-Content-Sha256"))this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const j=this.signQuery?this.url.searchParams:this.headers;if(j.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken)j.set("X-Amz-Security-Token",this.sessionToken);if(this.signableHeaders=["host",...this.headers.keys()].filter((F)=>W0||!D0.has(F)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map((F)=>F+":"+(F==="host"?this.url.host:(this.headers.get(F)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery){if(this.service==="s3"&&!j.has("X-Amz-Expires"))j.set("X-Amz-Expires","86400");j.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),j.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),j.set("X-Amz-SignedHeaders",this.signedHeaders)}if(this.service==="s3")try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(F){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");if(!X0)this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/");this.encodedPath=u(this.encodedPath);const R=new Set;this.encodedSearch=[...this.url.searchParams].filter(([F])=>{if(!F)return!1;if(this.service==="s3"){if(R.has(F))return!1;R.add(F)}return!0}).map((F)=>F.map((U)=>u(encodeURIComponent(U)))).sort(([F,U],[v,h])=>F<v?-1:F>v?1:U<h?-1:U>h?1:0).map((F)=>F.join("=")).join("&")}async sign(){if(this.signQuery){if(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken)this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)}else this.headers.set("Authorization",await this.authHeader());return{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const $=this.datetime.slice(0,8),W=[this.secretAccessKey,$,this.region,this.service].join();let X=this.cache.get(W);if(!X){const B=await H("AWS4"+this.secretAccessKey,$),D=await H(B,this.region),J=await H(D,this.service);X=await H(J,"aws4_request"),this.cache.set(W,X)}return _(await H(X,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,_(await b(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let $=this.headers.get("X-Amz-Content-Sha256")||(this.service==="s3"&&this.signQuery?"UNSIGNED-PAYLOAD":null);if($==null){if(this.body&&typeof this.body!=="string"&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");$=_(await b(this.body||""))}return $}}var y=($,W)=>{const X=W.parseFromString($,"text/xml"),B=X.getElementsByTagName("ListBucketResult")[0],D=X.getElementsByTagName("Contents"),J=X.getElementsByTagName("CommonPrefixes")[0];if(!B||!D)throw new Error(`Invalid XML: ${$}`);return{$metadata:{},IsTruncated:B.getElementsByTagName("IsTruncated")[0]?.textContent==="true",Contents:Array.from(D).map((Y)=>({ChecksumAlgorithm:[Y.getElementsByTagName("ChecksumAlgorithm")[0]?.textContent],ETag:Y.getElementsByTagName("ETag")[0]?.textContent,Key:Y.getElementsByTagName("Key")[0]?.textContent,LastModified:new Date(Y.getElementsByTagName("LastModified")[0]?.textContent),Owner:{DisplayName:Y.getElementsByTagName("DisplayName")[0]?.textContent,ID:Y.getElementsByTagName("ID")[0]?.textContent},Size:Number.parseInt(Y.getElementsByTagName("Size")[0]?.textContent),StorageClass:Y.getElementsByTagName("StorageClass")[0]?.textContent})),Name:X.getElementsByTagName("Name")[0]?.textContent,Prefix:X.getElementsByTagName("Prefix")[0]?.textContent,Delimiter:X.getElementsByTagName("Delimiter")[0]?.textContent,MaxKeys:Number.parseInt(X.getElementsByTagName("MaxKeys")[0]?.textContent),CommonPrefixes:Array.from(J?J.getElementsByTagName("Prefix"):[],(Y)=>({Prefix:Y?.textContent})),EncodingType:X.getElementsByTagName("EncodingType")[0]?.textContent,KeyCount:Number.parseInt(X.getElementsByTagName("KeyCount")[0]?.textContent),ContinuationToken:X.getElementsByTagName("ContinuationToken")[0]?.textContent,NextContinuationToken:X.getElementsByTagName("NextContinuationToken")[0]?.textContent,StartAfter:X.getElementsByTagName("StartAfter")[0]?.textContent}};class w{client;endpoint;parser;constructor($,W,X){this.client=$,this.endpoint=W,this.parser=X}async listObjectV2($){for(let W=0;W<10;W++){const X=`${this.endpoint}/${$.Bucket}/?list-type=2&prefix=${$.Prefix}`,B=await this.client(X,{});if(B.status===200){const D=await B.text();return y(D,this.parser)}else if(B.status===429)console.warn("listObjectV2: 429, retrying"),await new Promise((D)=>setTimeout(D,1000));else throw new Error(`Unexpected response: ${B.status} ${B.text()}`)}throw new Error("Cannot contact server")}async putObject($){const W=`${this.endpoint}/${$.Bucket}/${$.Key}`,X=await this.client(W,{method:"PUT",body:$.Body,headers:{"Content-Type":"application/json",...$.ChecksumSHA256&&{"x-amz-content-sha256":$.ChecksumSHA256}}});if(X.status!=200)throw new Error(`Failed to PUT: ${await X.text()}`);return{$metadata:{httpStatusCode:X.status},ETag:X.headers.get("ETag"),...X.headers.get("x-amz-version-id")&&{VersionId:X.headers.get("x-amz-version-id")}}}async deleteObject($){const W=`${this.endpoint}/${$.Bucket}/${$.Key}`;return{$metadata:{httpStatusCode:(await this.client(W,{method:"DELETE"})).status}}}async getObject($){const W=`${this.endpoint}/${$.Bucket}/${$.Key}?${$.VersionId?`versionId=${$.VersionId}`:""}`,X=await this.client(W,{method:"GET",headers:{"If-None-Match":$.IfNoneMatch}});if(X.status==304){const D=new Error;throw D.name="304",D}let B;if(X.status==404)B=void 0;else if(X.status==403)throw new Error("Access denied");else if(X.headers.get("content-type")==="application/json")B=await X.json();else{const D=await X.text();if(D==="")B=void 0;else try{B=JSON.parse(D)}catch(J){throw new Error(`Failed to parse response as JSON ${W}`)}}return{$metadata:{httpStatusCode:X.status},Body:B,ETag:X.headers.get("ETag"),...X.headers.get("x-amz-version-id")&&{VersionId:X.headers.get("x-amz-version-id")}}}}class L{key;_vals;_keys;constructor($,W){if(this.key=$,this._vals=new Map,this._keys=new Map,W)for(let[X,B]of W)this.set(X,B)}get size(){return this._vals.size}set($,W){const X=this.key($);return this._vals.set(X,W),this._keys.set(X,$),this}get($){return this._vals.get(this.key($))}delete($){const W=this.key($);return this._keys.delete(W),this._vals.delete(W)}has($){return this._vals.has(this.key($))}values(){return this._vals.values()}keys(){return this._keys.values()}forEach($){return this._vals.forEach((W,X,B)=>$(W,this._keys.get(X)))}}var m=()=>`${Date.now()-200}`.padStart(14,"0"),g=()=>`${Date.now()+200}`.padStart(14,"0");class A{pendingWrites=new Map;writtenOperations=new Map;observeVersionId($){if(this.writtenOperations.has($)){const W=this.writtenOperations.get($);this.pendingWrites.delete(W),this.writtenOperations.delete($)}}}var M=()=>crypto.randomUUID();var Q=($)=>`${$.bucket}/${$.key}`;var O=f(),z0=n(),N0=s();var P={previous:".",files:{},update:{}};class a{ref;handler;lastVersion;queue=Promise.resolve();constructor($,W){this.ref=$,this.handler=W}notify($,W,X){this.queue=this.queue.then(()=>X).then((B)=>{if(W===this.lastVersion)return;else console.log(`${$} NOTIFY ${Q(this.ref)} ${W}`),this.lastVersion=W,this.handler(B)})}}class x{service;ref;subscribers=new Set;poller;cache;pollInProgress=!1;authoritative_key="";authoritative_state=JSON.parse(JSON.stringify(P));optimistic_state=JSON.parse(JSON.stringify(P));operation_queue=new A;constructor($,W,X){console.log("New manifest",W),this.service=$,this.ref=W}observeVersionId($){this.operation_queue.observeVersionId($)}async get(){return this.getLatest().then(($)=>$||this.cache?.data)}async getLatest(){try{const $=await this.service._getObject({operation:"POLL_TIME",ref:this.ref,ifNoneMatch:this.cache?.etag});if($.$metadata.httpStatusCode===304)return;if($.data===void 0)this.authoritative_key=".";else this.authoritative_key=$.data;const W=await this.service.s3ClientLite.listObjectV2({Bucket:this.ref.bucket,Prefix:this.ref.key,StartAfter:this.authoritative_key});if(W.Contents===void 0)return this.authoritative_state=JSON.parse(JSON.stringify(P)),this.optimistic_state=JSON.parse(JSON.stringify(P)),this.authoritative_state;const X=`${this.ref.key}@${m()}`;for(let B=W.Contents.length-1;B>=0;B--){const D=W.Contents[B].Key;if(D==this.ref.key)continue;const J={bucket:this.ref.bucket,key:D},Y=await this.service._getObject({operation:"LOOK_BACK",ref:J});if(Y.data===void 0){await this.service._deleteObject({operation:"CLEANUP",ref:J});continue}if(Y.data.previous<X){this.authoritative_key=Y.data.previous,this.authoritative_state=Y.data;break}}for(let B=0;B<W.Contents.length;B++){const D=W.Contents[B].Key;if(D==this.ref.key)continue;if(D<this.authoritative_key)continue;const J=await this.service._getObject({operation:"SWEEP",ref:{bucket:this.ref.bucket,key:D}}),Y=D.substring(D.lastIndexOf("@")+1);if(Y>=X)console.log("Optimistic update"),this.optimistic_state=O(this.optimistic_state,J.data?.update);else this.authoritative_state=O(this.authoritative_state,J.data?.update),this.optimistic_state=O(this.optimistic_state,J.data?.update),this.authoritative_key=D;this.observeVersionId(Y)}return this.authoritative_state}catch($){if($.name==="NoSuchKey")return this.authoritative_state=P,this.authoritative_state;else throw $}}async poll(){if(this.pollInProgress)return;if(this.pollInProgress=!0,this.subscriberCount===0&&this.poller)clearInterval(this.poller),this.poller=void 0;if(this.subscriberCount>0&&!this.poller)this.poller=setInterval(()=>this.poll(),this.service.config.pollFrequency);const $=await this.getLatest();if($===void 0){this.pollInProgress=!1;return}const W=new Map;this.operation_queue.pendingWrites.forEach((X)=>{X.forEach((B,D)=>{W.set(Q(D),B)})}),this.subscribers.forEach(async(X)=>{if(W.has(Q(X.ref)))X.notify(this.service.config.label,"local",Promise.resolve(W.get(Q(X.ref))));else{const B=$.files[Q(X.ref)];if(B){const D=this.service._getObject({operation:"GET_CONTENT",ref:X.ref,version:B.version});X.notify(this.service.config.label,B.version,D.then((J)=>J.data))}else if(B===null)X.notify(this.service.config.label,void 0,Promise.resolve(void 0))}}),this.pollInProgress=!1}async updateContent($,W){this.operation_queue.pendingWrites.set(W,$);const X=await W,B=await this.get();B.previous=this.authoritative_key,B.update={files:{}};for(let[Y,Z]of X){const G=Q(Y);if(Z){const z={version:Z};B.update.files[G]=z}else B.update.files[G]=null}const D=g()+"_"+M().substring(0,2);this.operation_queue.writtenOperations.set(D,W);const J=this.ref.key+"@"+D;try{await this.service._putObject({operation:"PUT_MANIFEST",ref:{key:J,bucket:this.ref.bucket},value:B});const Y=await this.service._putObject({operation:"PUT_POLL",ref:{key:this.ref.key,bucket:this.ref.bucket},value:this.authoritative_key});return this.poll(),Y}catch(Y){throw console.error(Y),this.operation_queue.pendingWrites.delete(W),this.operation_queue.writtenOperations.delete(D),Y}}async getOptimisticVersion($){return await this.get(),this.optimistic_state.files[Q($)]?.version}subscribe($,W){console.log(`SUBSCRIBE ${Q($)} ${this.subscriberCount+1}`);const X=new a($,W);return this.subscribers.add(X),()=>this.subscribers.delete(X)}get subscriberCount(){return this.subscribers.size}}async function r($){const W=(new TextEncoder()).encode($),X=await crypto.subtle.digest("SHA-256",W);return[...new Uint8Array(X)].map((B)=>B.toString(16).padStart(2,"0")).join("")}class j0{config;s3ClientLite;manifests=new L(Q);getCache=new L(($)=>`${$.Bucket}${$.Key}${$.VersionId}${$.IfNoneMatch}`);constructor($){if(this.config={...$,label:$.label||M().substring(0,3),useChecksum:$.useChecksum===!1?!1:!0,useVersioning:$.useVersioning||!1,pollFrequency:$.pollFrequency||1000,defaultManifest:{bucket:$.defaultManifest?.bucket||$.defaultBucket,key:typeof $.defaultManifest=="string"?$.defaultManifest:$.defaultManifest?.key||"manifest.json"}},this.config.s3Config?.credentials instanceof Function)throw Error("We can't do that yet");const W=$.s3Config.endpoint||`https://s3.${$.s3Config.region}.amazonaws.com`;let X;if(this.config.s3Config?.credentials){const B=new E({accessKeyId:this.config.s3Config.credentials.accessKeyId,secretAccessKey:this.config.s3Config.credentials.secretAccessKey,sessionToken:this.config.s3Config.credentials.sessionToken,region:this.config.s3Config.region||"us-east-1",service:"s3",retries:0});X=(...D)=>B.fetch(...D)}else X=(global||window).fetch.bind(global||window);this.s3ClientLite=new w(X,W,$.parser||new DOMParser)}getOrCreateManifest($){if(!this.manifests.has($))this.manifests.set($,new x(this,$));return this.manifests.get($)}async get($,W={}){const X={...this.config.defaultManifest,...W.manifest},B=this.getOrCreateManifest(X),D={bucket:$.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof $==="string"?$:$.key};let J=!1,Y=void 0;for(let[G,z]of B.operation_queue.pendingWrites)if(z.has(D))J=!0,Y=z.get(D);if(J)return console.log(`${this.config.label} get (cached) ${Q(D)}`),Y;const Z=await B.getOptimisticVersion(D);if(Z===void 0)return;return(await this._getObject({operation:"GET",ref:D,version:Z})).data}async _getObject($){let W;if(this.config.useVersioning)W={Bucket:$.ref.bucket,Key:$.ref.key,IfNoneMatch:$.ifNoneMatch,...$.version&&{VersionId:$.version}};else W={Bucket:$.ref.bucket,Key:`${$.ref.key}${$.version?`@${$.version}`:""}`,IfNoneMatch:$.ifNoneMatch};if(this.getCache.has(W))return await this.getCache.get(W);const X=this.s3ClientLite.getObject(W).then(async(B)=>{const D={...B,data:B.Body};return console.log(`${this.config.label} ${$.operation} ${$.ref.bucket}/${$.ref.key}@${$.version} => ${D.VersionId}`),this.getCache.set(W,X),D}).catch((B)=>{if(B?.name==="304")return{$metadata:{httpStatusCode:304},data:void 0};else throw B});return X}async delete($,W={}){return this.putAll(new Map([[$,void 0]]),W)}async put($,W,X={}){return this.putAll(new Map([[$,W]]),X)}async putAll($,W={}){const X=new L(Q,[...$].map(([D,J])=>[{bucket:D.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof D==="string"?D:D.key},J])),B=(W?.manifests||[this.config.defaultManifest]).map((D)=>({...this.config.defaultManifest,...D}));return this._putAll(X,{manifests:B})}async _putAll($,W){const X=new Promise(async(B,D)=>{const J=new Map,Y=[];$.forEach((Z,G)=>{if(Z!==void 0){let z=this.config.useVersioning?void 0:M();Y.push(this._putObject({operation:"PUT_CONTENT",ref:G,value:Z,version:z}).then((N)=>{if(this.config.useVersioning)if(N.VersionId===void 0)throw console.error(N),Error(`Bucket ${G.bucket} is not version enabled!`);else z=N.VersionId;J.set(G,z)}))}else Y.push(this._deleteObject({ref:G}).then((z)=>{J.set(G,void 0)}))}),await Promise.all(Y).catch(D),B(J)});return Promise.all(W.manifests.map((B)=>{return this.getOrCreateManifest(B).updateContent($,X)}))}async _putObject($){const W=JSON.stringify($.value,null,2);let X;if(this.config.useVersioning)X={Bucket:$.ref.bucket,Key:$.ref.key,ContentType:"application/json",Body:W,...this.config.useChecksum&&{ChecksumSHA256:await r(W)}};else X={Bucket:$.ref.bucket,Key:`${$.ref.key}${$.version?`@${$.version}`:""}`,ContentType:"application/json",Body:W,...this.config.useChecksum&&{ChecksumSHA256:await r(W)}};const B=await this.s3ClientLite.putObject(X);return console.log(`${this.config.label} ${$.operation} ${X.Bucket}/${X.Key} => ${B.VersionId}`),B}async _deleteObject($){const W={Bucket:$.ref.bucket,Key:$.ref.key},X=await this.s3ClientLite.deleteObject(W);return console.log(`${this.config.label} ${$.operation||"DELETE"} ${$.ref.bucket}/${$.ref.key} => ${X.VersionId}`),X}subscribe($,W,X){const B={...this.config.defaultManifest,...X?.manifest},D={key:typeof $==="string"?$:$.key,bucket:$.bucket||this.config.defaultBucket||B.bucket},J=this.getOrCreateManifest(B),Y=J.subscribe(D,W);return this.get(D,{manifest:B}).then((Z)=>{console.log(`${this.config.label} NOTIFY (initial) ${Q(D)}`),queueMicrotask(()=>{W(Z),J.poll()})}),Y}refresh(){return Promise.all([...this.manifests.values()].map(($)=>$.poll()))}get subscriberCount(){return[...this.manifests.values()].reduce(($,W)=>$+W.subscriberCount,0)}}export{j0 as MPS3};
