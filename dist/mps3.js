async function H($,J){const z=await crypto.subtle.importKey("raw",typeof $==="string"?I.encode($):$,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",z,I.encode(J))}async function f($){return crypto.subtle.digest("SHA-256",typeof $==="string"?I.encode($):$)}var q=function($){return Array.prototype.map.call(new Uint8Array($),(J)=>("0"+J.toString(16)).slice(-2)).join("")},l=function($){return $.replace(/[!'()*]/g,(J)=>"%"+J.charCodeAt(0).toString(16).toUpperCase())},J0=function($,J){const{hostname:z,pathname:W}=$;if(z.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(z.endsWith(".backblazeb2.com")){const Q=z.match(/^(?:[^.]+\.)?s3\.([^.]+)\.backblazeb2\.com$/);return Q!=null?["s3",Q[1]]:["",""]}const Y=z.replace("dualstack.","").match(/([^.]+)\.(?:([^.]*)\.)?amazonaws\.com(?:\.cn)?$/);let[X,Z]=(Y||["",""]).slice(1,3);if(Z==="us-gov")Z="us-gov-west-1";else if(Z==="s3"||Z==="s3-accelerate")Z="us-east-1",X="s3";else if(X==="iot")if(z.startsWith("iot."))X="execute-api";else if(z.startsWith("data.jobs.iot."))X="iot-jobs-data";else X=W==="/mqtt"?"iotdevicegateway":"iotdata";else if(X==="autoscaling"){const Q=(J.get("X-Amz-Target")||"").split(".")[0];if(Q==="AnyScaleFrontendService")X="application-autoscaling";else if(Q==="AnyScaleScalingPlannerFrontendService")X="autoscaling-plans"}else if(Z==null&&X.startsWith("s3-"))Z=X.slice(3).replace(/^fips-|^external-1/,""),X="s3";else if(X.endsWith("-fips"))X=X.slice(0,-5);else if(Z&&/-\d$/.test(X)&&!/-\d$/.test(Z))[X,Z]=[Z,X];return[e[X]||X,Z]},I=new TextEncoder,e={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},$0=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class x{constructor({accessKeyId:$,secretAccessKey:J,sessionToken:z,service:W,region:Y,cache:X,retries:Z,initRetryMs:Q}){if($==null)throw new TypeError("accessKeyId is a required option");if(J==null)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=$,this.secretAccessKey=J,this.sessionToken=z,this.service=W,this.region=Y,this.cache=X||new Map,this.retries=Z!=null?Z:10,this.initRetryMs=Q||50}async sign($,J){if($ instanceof Request){const{method:Y,url:X,headers:Z,body:Q}=$;if(J=Object.assign({method:Y,url:X,headers:Z},J),J.body==null&&Z.has("Content-Type"))J.body=Q!=null&&Z.has("X-Amz-Content-Sha256")?Q:await $.clone().arrayBuffer();$=X}const z=new u(Object.assign({url:$},J,this,J&&J.aws)),W=Object.assign({},J,await z.sign());delete W.aws;try{return new Request(W.url.toString(),W)}catch(Y){if(Y instanceof TypeError)return new Request(W.url.toString(),Object.assign({duplex:"half"},W));throw Y}}async fetch($,J){for(let z=0;z<=this.retries;z++){const W=fetch(await this.sign($,J));if(z===this.retries)return W;const Y=await W;if(Y.status<500&&Y.status!==429)return Y;await new Promise((X)=>setTimeout(X,Math.random()*this.initRetryMs*Math.pow(2,z)))}throw new Error("An unknown error occurred, ensure retries is not negative")}}class u{constructor({method:$,url:J,headers:z,body:W,accessKeyId:Y,secretAccessKey:X,sessionToken:Z,service:Q,region:P,cache:F,datetime:L,signQuery:_,appendSessionToken:A,allHeaders:s,singleEncode:r}){if(J==null)throw new TypeError("url is a required option");if(Y==null)throw new TypeError("accessKeyId is a required option");if(X==null)throw new TypeError("secretAccessKey is a required option");this.method=$||(W?"POST":"GET"),this.url=new URL(J),this.headers=new Headers(z||{}),this.body=W,this.accessKeyId=Y,this.secretAccessKey=X,this.sessionToken=Z;let k,m;if(!Q||!P)[k,m]=J0(this.url,this.headers);if(this.service=Q||k||"",this.region=P||m||"us-east-1",this.cache=F||new Map,this.datetime=L||(new Date()).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=_,this.appendSessionToken=A||this.service==="iotdevicegateway",this.headers.delete("Host"),this.service==="s3"&&!this.signQuery&&!this.headers.has("X-Amz-Content-Sha256"))this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const B=this.signQuery?this.url.searchParams:this.headers;if(B.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken)B.set("X-Amz-Security-Token",this.sessionToken);if(this.signableHeaders=["host",...this.headers.keys()].filter((D)=>s||!$0.has(D)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map((D)=>D+":"+(D==="host"?this.url.host:(this.headers.get(D)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery){if(this.service==="s3"&&!B.has("X-Amz-Expires"))B.set("X-Amz-Expires","86400");B.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),B.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),B.set("X-Amz-SignedHeaders",this.signedHeaders)}if(this.service==="s3")try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(D){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");if(!r)this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/");this.encodedPath=l(this.encodedPath);const p=new Set;this.encodedSearch=[...this.url.searchParams].filter(([D])=>{if(!D)return!1;if(this.service==="s3"){if(p.has(D))return!1;p.add(D)}return!0}).map((D)=>D.map((K)=>l(encodeURIComponent(K)))).sort(([D,K],[y,d])=>D<y?-1:D>y?1:K<d?-1:K>d?1:0).map((D)=>D.join("=")).join("&")}async sign(){if(this.signQuery){if(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken)this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)}else this.headers.set("Authorization",await this.authHeader());return{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const $=this.datetime.slice(0,8),J=[this.secretAccessKey,$,this.region,this.service].join();let z=this.cache.get(J);if(!z){const W=await H("AWS4"+this.secretAccessKey,$),Y=await H(W,this.region),X=await H(Y,this.service);z=await H(X,"aws4_request"),this.cache.set(J,z)}return q(await H(z,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,q(await f(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let $=this.headers.get("X-Amz-Content-Sha256")||(this.service==="s3"&&this.signQuery?"UNSIGNED-PAYLOAD":null);if($==null){if(this.body&&typeof this.body!=="string"&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");$=q(await f(this.body||""))}return $}}var c=($,J)=>{const z=J.parseFromString($,"text/xml"),W=z.getElementsByTagName("ListBucketResult")[0],Y=z.getElementsByTagName("Contents"),X=z.getElementsByTagName("CommonPrefixes")[0];if(!W||!Y)throw new Error(`Invalid XML: ${$}`);return{$metadata:{},IsTruncated:W.getElementsByTagName("IsTruncated")[0]?.textContent==="true",Contents:Array.from(Y).map((Z)=>({ChecksumAlgorithm:[Z.getElementsByTagName("ChecksumAlgorithm")[0]?.textContent],ETag:Z.getElementsByTagName("ETag")[0]?.textContent,Key:Z.getElementsByTagName("Key")[0]?.textContent,LastModified:new Date(Z.getElementsByTagName("LastModified")[0]?.textContent),Owner:{DisplayName:Z.getElementsByTagName("DisplayName")[0]?.textContent,ID:Z.getElementsByTagName("ID")[0]?.textContent},Size:Number.parseInt(Z.getElementsByTagName("Size")[0]?.textContent),StorageClass:Z.getElementsByTagName("StorageClass")[0]?.textContent})),Name:z.getElementsByTagName("Name")[0]?.textContent,Prefix:z.getElementsByTagName("Prefix")[0]?.textContent,Delimiter:z.getElementsByTagName("Delimiter")[0]?.textContent,MaxKeys:Number.parseInt(z.getElementsByTagName("MaxKeys")[0]?.textContent),CommonPrefixes:Array.from(X?X.getElementsByTagName("Prefix"):[],(Z)=>({Prefix:Z?.textContent})),EncodingType:z.getElementsByTagName("EncodingType")[0]?.textContent,KeyCount:Number.parseInt(z.getElementsByTagName("KeyCount")[0]?.textContent),ContinuationToken:z.getElementsByTagName("ContinuationToken")[0]?.textContent,NextContinuationToken:z.getElementsByTagName("NextContinuationToken")[0]?.textContent,StartAfter:z.getElementsByTagName("StartAfter")[0]?.textContent}};var V=async($,{retries:J=Number.MAX_VALUE,delay:z=100}={})=>{try{return await $()}catch(W){if(J>0)return await new Promise((Y)=>setTimeout(Y,z)),V($,{retries:J-1,delay:z});throw W}};class R{$;J;z;constructor($,J,z){this.fetch=$;this.endpoint=J;this.parser=z}getUrl($,J,z){return`${this.endpoint}/${$}${J?`/${J}`:""}${z||""}`}async listObjectV2($){for(let J=0;J<10;J++){const z=this.getUrl($.Bucket,void 0,`/?list-type=2&prefix=${$.Prefix}`),W=await V(()=>this.fetch(z,{}));if(W.status===200)return c(await W.text(),this.parser);else if(W.status===429)console.warn("listObjectV2: 429, retrying"),await new Promise((Y)=>setTimeout(Y,1000));else throw new Error(`Unexpected response: ${W.status} ${await W.text()}`)}throw new Error("Cannot contact server")}async putObject({Bucket:$,Key:J,Body:z,ChecksumSHA256:W}){const Y=this.getUrl($,J),X=await V(()=>this.fetch(Y,{method:"PUT",body:z,headers:{"Content-Type":"application/json",...W&&{"x-amz-content-sha256":W}}}));if(X.status!==200)throw new Error(`Failed to PUT: ${await X.text()}`);return{$metadata:{httpStatusCode:X.status},ETag:X.headers.get("ETag"),...X.headers.get("x-amz-version-id")&&{VersionId:X.headers.get("x-amz-version-id")}}}async deleteObject({Bucket:$,Key:J}){return{$metadata:{httpStatusCode:(await V(()=>this.fetch(this.getUrl($,J),{method:"DELETE"}))).status}}}async getObject({Bucket:$,Key:J,VersionId:z,IfNoneMatch:W}){const Y=this.getUrl($,J,z?`?versionId=${z}`:""),X=await V(()=>this.fetch(Y,{method:"GET",headers:{"If-None-Match":W}}));switch(X.status){case 304:throw new Error("304");case 404:return{$metadata:{httpStatusCode:404}};case 403:throw new Error("Access denied");default:{let Z;const Q=X.headers.get("content-type"),P=await X.text();if(Q==="application/json"||P&&P!=="")try{Z=JSON.parse(P)}catch(F){throw new Error(`Failed to parse response as JSON ${Y}`)}return{$metadata:{httpStatusCode:X.status},Body:Z,ETag:X.headers.get("ETag"),...X.headers.get("x-amz-version-id")&&{VersionId:X.headers.get("x-amz-version-id")}}}}}}class U{key;_vals;_keys;constructor($,J){if(this.key=$,this._vals=new Map,this._keys=new Map,J)for(let[z,W]of J)this.set(z,W)}get size(){return this._vals.size}set($,J){const z=this.key($);return this._vals.set(z,J),this._keys.set(z,$),this}get($){return this._vals.get(this.key($))}delete($){const J=this.key($);return this._keys.delete(J),this._vals.delete(J)}has($){return this._vals.has(this.key($))}values(){return this._vals.values()}keys(){return this._keys.values()}forEach($){return this._vals.forEach((J,z,W)=>$(J,this._keys.get(z)))}}var i=()=>`${Date.now()-200}`.padStart(14,"0"),a=()=>`${Date.now()+200}`.padStart(14,"0");var O=()=>crypto.randomUUID();var j=($)=>`${$.bucket}/${$.key}`,C=($,J)=>new URL(`${$}/${J.bucket}/${J.key}`);var M=($)=>JSON.parse(JSON.stringify($));var E=function($){return new Promise((J,z)=>{$.oncomplete=$.onsuccess=()=>J($.result),$.onabort=$.onerror=()=>z($.error)})},W0=function($,J){const z=indexedDB.open($);z.onupgradeneeded=()=>z.result.createObjectStore(J);const W=E(z);return(Y,X)=>W.then((Z)=>X(Z.transaction(J,Y).objectStore(J)))},w=function(){if(!h)h=W0("keyval-store","keyval");return h},S=function($,J=w()){return J("readonly",(z)=>E(z.get($)))},b=function($,J,z=w()){return z("readwrite",(W)=>{return W.put(J,$),E(W.transaction)})};var G=function($,J=w()){return J("readwrite",(z)=>{return z.delete($),E(z.transaction)})};var X0=function($,J){return $.openCursor().onsuccess=function(){if(!this.result)return;J(this.result),this.result.continue()},E($.transaction)},n=function($=w()){return $("readonly",(J)=>{if(J.getAllKeys)return E(J.getAllKeys());const z=[];return X0(J,(W)=>z.push(W.key)).then(()=>z)})};var h;var Y0=6;class v{session=O();proposedOperations=new Map;operationLabels=new Map;db;lastIndex=0;constructor($){this.db=$}async propose($,J){if(this.proposedOperations.set($,J),this.db){this.lastIndex++;const z=`entry-${this.lastIndex.toString().padStart(Y0,"0")}`;$[this.session]=this.lastIndex,await b(z,[...J.entries()].map(([W,Y])=>[W.toString(),Y]),this.db)}}async label($,J){if(this.operationLabels.set(J,$),this.db){const z=$[this.session];if(z===void 0)throw new Error("Cannot label an unproposed operation");await b(`label-${z}`,J,this.db)}}async confirm($){if(this.operationLabels.has($)){const J=this.operationLabels.get($);if(this.proposedOperations.delete(J),this.operationLabels.delete($),this.db){const z=J[this.session];await G(`entry-${z}`,this.db),await G(`label-${z}`,this.db)}}}async cancel($){let J;if(this.operationLabels.forEach((z,W)=>{if(z===$)this.operationLabels.delete(W)}),this.proposedOperations.delete($),this.db){const z=$[this.session];await G(`entry-${z}`,this.db),await G(`label-${z}`,this.db)}}flatten(){const $=new U((J)=>J.toString());return this.proposedOperations.forEach((J)=>{J.forEach((z,W)=>{$.set(W,z)})}),$}async restore($,J){this.db=$,this.proposedOperations.clear(),this.operationLabels.clear(),this.lastIndex=0;const W=(await n(this.db)).filter((Y)=>Y.startsWith("entry-")).sort();for(let Y of W){const X=parseInt(Y.split("-")[1]),Z=await S(Y,this.db),Q=await S(`label-${X}`,this.db);if(!Z)continue;const P=Z.map(([_,A])=>[new URL(_),A]),F=new Map(P),L=J(F);if(L[this.session]=X,this.proposedOperations.set(L,F),Q)this.label(L,Q);this.lastIndex=Math.max(this.lastIndex,X)}}}function N($,J){if(Array.isArray(J)||typeof J!=="object"||J===null)return J;if(typeof $!=="object"||$===null)$={};for(let z in J)if(J[z]===null)delete $[z];else $[z]=N($[z],J[z]);return $}var T={previous:".",files:{},update:{}};class o{$;J;z;queue=Promise.resolve();constructor($,J,z){this.ref=$;this.handler=J;this.lastVersion=z}notify($,J,z){this.queue=this.queue.then(()=>z).then((W)=>{if(J!==this.lastVersion)console.log(`${$} NOTIFY ${j(this.ref)} ${J}`),this.lastVersion=J,this.handler(W)})}}class g{$;J;subscribers=new Set;poller;cache;pollInProgress=!1;authoritative_key="";authoritative_state=M(T);optimistic_state=M(T);operation_queue=new v;constructor($,J,z){this.service=$;this.ref=J;console.log("New manifest",J)}observeVersionId($){this.operation_queue.confirm($)}async get(){return this.getLatest().then(($)=>$||this.cache?.data)}async getLatest(){try{const $=await this.service._getObject({operation:"POLL_TIME",ref:this.ref,ifNoneMatch:this.cache?.etag});if($.$metadata.httpStatusCode===304)return;if($.data===void 0)this.authoritative_key=".";else this.authoritative_key=$.data;const J=await this.service.s3ClientLite.listObjectV2({Bucket:this.ref.bucket,Prefix:this.ref.key,StartAfter:this.authoritative_key});if(J.Contents===void 0)return this.authoritative_state=M(T),this.optimistic_state=M(T),this.authoritative_state;const z=`${this.ref.key}@${i()}`;for(let W=J.Contents.length-1;W>=0;W--){const Y=J.Contents[W].Key;if(Y==this.ref.key)continue;const X={bucket:this.ref.bucket,key:Y},Z=await this.service._getObject({operation:"LOOK_BACK",ref:X});if(Z.data===void 0){await this.service._deleteObject({operation:"CLEANUP",ref:X});continue}if(Z.data.previous<z){this.authoritative_key=Z.data.previous,this.authoritative_state=Z.data;break}}for(let W=0;W<J.Contents.length;W++){const Y=J.Contents[W].Key;if(Y==this.ref.key)continue;if(Y<this.authoritative_key)continue;const X=await this.service._getObject({operation:"SWEEP",ref:{bucket:this.ref.bucket,key:Y}}),Z=Y.substring(Y.lastIndexOf("@")+1);if(Z>=z)console.log("Optimistic update"),this.optimistic_state=N(this.optimistic_state,X.data?.update);else this.authoritative_state=N(this.authoritative_state,X.data?.update),this.optimistic_state=N(this.optimistic_state,X.data?.update),this.authoritative_key=Y;this.observeVersionId(Z)}return this.authoritative_state}catch($){if($.name==="NoSuchKey")return this.authoritative_state=T,this.authoritative_state;else throw $}}async poll(){if(this.pollInProgress)return;if(this.pollInProgress=!0,this.subscriberCount===0&&this.poller)clearInterval(this.poller),this.poller=void 0;if(this.subscriberCount>0&&!this.poller)this.poller=setInterval(()=>this.poll(),this.service.config.pollFrequency);const $=await this.getLatest();if($===void 0){this.pollInProgress=!1;return}const J=this.operation_queue.flatten();this.subscribers.forEach(async(z)=>{if(J.has(C(this.service.endpoint,z.ref)))z.notify(this.service.config.label,"local",Promise.resolve(J.get(C(this.service.endpoint,z.ref))));else{const W=$.files[j(z.ref)];if(W){const Y=this.service._getObject({operation:"GET_CONTENT",ref:z.ref,version:W.version});z.notify(this.service.config.label,W.version,Y.then((X)=>X.data))}else if(W===null)z.notify(this.service.config.label,void 0,Promise.resolve(void 0))}}),this.pollInProgress=!1}async updateContent($,J){this.operation_queue.propose(J,$);try{const z=await J,W=await this.get();W.previous=this.authoritative_key,W.update={files:{}};for(let[Q,P]of z){const F=j(Q);if(P){const L={version:P};W.update.files[F]=L}else W.update.files[F]=null}const Y=a()+"_"+O().substring(0,2),X=this.ref.key+"@"+Y;this.operation_queue.label(J,Y),await this.service._putObject({operation:"PUT_MANIFEST",ref:{key:X,bucket:this.ref.bucket},value:W});const Z=await this.service._putObject({operation:"PUT_POLL",ref:{key:this.ref.key,bucket:this.ref.bucket},value:this.authoritative_key});return this.poll(),Z}catch(z){throw console.error(z),this.operation_queue.cancel(J),z}}async getOptimisticVersion($){return await this.get(),this.optimistic_state.files[j($)]?.version}subscribe($,J){console.log(`SUBSCRIBE ${j($)} ${this.subscriberCount+1}`);const z=new o($,J);return this.subscribers.add(z),()=>this.subscribers.delete(z)}get subscriberCount(){return this.subscribers.size}}async function t($){const J=(new TextEncoder()).encode($),z=await crypto.subtle.digest("SHA-256",J);return[...new Uint8Array(z)].map((W)=>W.toString(16).padStart(2,"0")).join("")}class Z0{config;s3ClientLite;manifests=new U(j);getCache=new U(($)=>`${$.Bucket}${$.Key}${$.VersionId}${$.IfNoneMatch}`);endpoint;constructor($){if(this.config={...$,label:$.label||O().substring(0,3),useChecksum:$.useChecksum===!1?!1:!0,useVersioning:$.useVersioning||!1,pollFrequency:$.pollFrequency||1000,defaultManifest:{bucket:$.defaultManifest?.bucket||$.defaultBucket,key:typeof $.defaultManifest=="string"?$.defaultManifest:$.defaultManifest?.key||"manifest.json"}},this.config.s3Config?.credentials instanceof Function)throw Error("We can't do that yet");this.endpoint=$.s3Config.endpoint||`https://s3.${$.s3Config.region}.amazonaws.com`;let J;if(this.config.s3Config?.credentials){const z=new x({accessKeyId:this.config.s3Config.credentials.accessKeyId,secretAccessKey:this.config.s3Config.credentials.secretAccessKey,sessionToken:this.config.s3Config.credentials.sessionToken,region:this.config.s3Config.region||"us-east-1",service:"s3",retries:0});J=(...W)=>z.fetch(...W)}else J=(global||window).fetch.bind(global||window);this.s3ClientLite=new R(J,this.endpoint,$.parser||new DOMParser)}getOrCreateManifest($){if(!this.manifests.has($))this.manifests.set($,new g(this,$));return this.manifests.get($)}async get($,J={}){const z={...this.config.defaultManifest,...J.manifest},W=this.getOrCreateManifest(z),Y={bucket:$.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof $==="string"?$:$.key},X=W.operation_queue.flatten(),Z=C(this.endpoint,Y);if(X.has(Z))return console.log(`${this.config.label} get (cached) ${j(Y)}`),X.get(Z);const Q=await W.getOptimisticVersion(Y);if(Q===void 0)return;return(await this._getObject({operation:"GET",ref:Y,version:Q})).data}async _getObject($){let J;if(this.config.useVersioning)J={Bucket:$.ref.bucket,Key:$.ref.key,IfNoneMatch:$.ifNoneMatch,...$.version&&{VersionId:$.version}};else J={Bucket:$.ref.bucket,Key:`${$.ref.key}${$.version?`@${$.version}`:""}`,IfNoneMatch:$.ifNoneMatch};if(this.getCache.has(J))return await this.getCache.get(J);const z=this.s3ClientLite.getObject(J).then(async(W)=>{const Y={...W,data:W.Body};return console.log(`${this.config.label} ${$.operation} ${$.ref.bucket}/${$.ref.key}@${$.version} => ${Y.VersionId}`),this.getCache.set(J,z),Y}).catch((W)=>{if(W?.name==="304")return{$metadata:{httpStatusCode:304},data:void 0};else throw W});return z}async delete($,J={}){return this.putAll(new Map([[$,void 0]]),J)}async put($,J,z={}){return this.putAll(new Map([[$,J]]),z)}async putAll($,J={}){const z=new U(j,[...$].map(([Y,X])=>[{bucket:Y.bucket||this.config.defaultBucket||this.config.defaultManifest.bucket,key:typeof Y==="string"?Y:Y.key},X])),W=(J?.manifests||[this.config.defaultManifest]).map((Y)=>({...this.config.defaultManifest,...Y}));return this._putAll(z,{manifests:W})}async _putAll($,J){const z=new Map,W=new Promise(async(Y,X)=>{const Z=new Map,Q=[];$.forEach((P,F)=>{if(P!==void 0){let L=this.config.useVersioning?void 0:O();z.set(C(this.endpoint,F),P),Q.push(this._putObject({operation:"PUT_CONTENT",ref:F,value:P,version:L}).then((_)=>{if(this.config.useVersioning)if(_.VersionId===void 0)throw console.error(_),Error(`Bucket ${F.bucket} is not version enabled!`);else L=_.VersionId;Z.set(F,L)}))}else Q.push(this._deleteObject({ref:F}).then((L)=>{Z.set(F,void 0)}))}),await Promise.all(Q).catch(X),Y(Z)});return Promise.all(J.manifests.map((Y)=>{return this.getOrCreateManifest(Y).updateContent(z,W)}))}async _putObject($){const J=JSON.stringify($.value,null,2);let z;if(this.config.useVersioning)z={Bucket:$.ref.bucket,Key:$.ref.key,ContentType:"application/json",Body:J,...this.config.useChecksum&&{ChecksumSHA256:await t(J)}};else z={Bucket:$.ref.bucket,Key:`${$.ref.key}${$.version?`@${$.version}`:""}`,ContentType:"application/json",Body:J,...this.config.useChecksum&&{ChecksumSHA256:await t(J)}};const W=await this.s3ClientLite.putObject(z);return console.log(`${this.config.label} ${$.operation} ${z.Bucket}/${z.Key} => ${W.VersionId}`),W}async _deleteObject($){const J={Bucket:$.ref.bucket,Key:$.ref.key},z=await this.s3ClientLite.deleteObject(J);return console.log(`${this.config.label} ${$.operation||"DELETE"} ${$.ref.bucket}/${$.ref.key} => ${z.VersionId}`),z}subscribe($,J,z){const W={...this.config.defaultManifest,...z?.manifest},Y={key:typeof $==="string"?$:$.key,bucket:$.bucket||this.config.defaultBucket||W.bucket},X=this.getOrCreateManifest(W),Z=X.subscribe(Y,J);return this.get(Y,{manifest:W}).then((Q)=>{console.log(`${this.config.label} NOTIFY (initial) ${j(Y)}`),queueMicrotask(()=>{J(Q),X.poll()})}),Z}refresh(){return Promise.all([...this.manifests.values()].map(($)=>$.poll()))}get subscriberCount(){return[...this.manifests.values()].reduce(($,J)=>$+J.subscriberCount,0)}}export{Z0 as MPS3};
